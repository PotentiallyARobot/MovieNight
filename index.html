<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MovieNight ‚Äî Stop Fighting About What to Watch</title>
  <meta name="description" content="A tiny app that keeps movie night fair ‚Äî and slightly dramatic.">
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --p1: #FF6B6B; --p1-soft: rgba(255,107,107,0.15);
      --p2: #4ECDC4; --p2-soft: rgba(78,205,196,0.15);
      --gold: #FFD93D; --gold-soft: rgba(255,217,61,0.15);
      --purple: #A855F7;
      --bg: #0f0f13; --card: rgba(24,24,31,0.85); --card-solid: #18181f; --elevated: rgba(34,34,48,0.9);
      --text: #FAFAFA; --muted: #a0a0b0; --dim: #606070;
    }
    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg); color: var(--text);
      min-height: 100vh; overflow-x: hidden;
    }
    /* Background image layer */
    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-image: url('movienight_bg_final.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      pointer-events: none;
      z-index: 0;
    }
    /* Mobile background */
    @media (max-width: 768px) {
      body::before {
        background-image: url('movienight_mobile_bg_good.png');
      }
    }
    /* Hide scrollbar but allow scrolling */
    ::-webkit-scrollbar { width: 0; height: 0; background: transparent; }
    * { scrollbar-width: none; -ms-overflow-style: none; }
    #root { position: relative; z-index: 1; }
    .space { font-family: 'Space Grotesk', sans-serif; }
    @keyframes reveal { 0%{opacity:0;transform:scale(0.95) translateY(20px)} 100%{opacity:1;transform:scale(1) translateY(0)} }
    @keyframes spin { to{transform:rotate(360deg)} }
    @keyframes glow { 0%,100%{box-shadow:0 0 30px rgba(255,217,61,0.4)} 50%{box-shadow:0 0 50px rgba(255,217,61,0.6)} }
    @keyframes slideIn { 0%{opacity:0;transform:translateY(15px)} 100%{opacity:1;transform:translateY(0)} }
    @keyframes fadeIn { 0%{opacity:0} 100%{opacity:1} }
    @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-3px)} 75%{transform:translateX(3px)} }
    @keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.03)} }
    @keyframes verdictReveal { 0%{opacity:0;transform:scale(0.8) rotate(-2deg)} 50%{transform:scale(1.05) rotate(1deg)} 100%{opacity:1;transform:scale(1) rotate(0)} }
    @keyframes barGrow { 0%{width:0} 100%{width:var(--target-width)} }
    input[type="range"] { -webkit-appearance:none; background:transparent; cursor:pointer; width:100%; }
    input[type="range"]::-webkit-slider-thumb { -webkit-appearance:none; height:22px; width:22px; border-radius:50%; background:currentColor; margin-top:-8px; box-shadow:0 2px 10px rgba(0,0,0,0.4); }
    input[type="range"]::-webkit-slider-runnable-track { height:6px; border-radius:3px; }
    input[type="range"]::-moz-range-thumb { height:22px; width:22px; border-radius:50%; background:currentColor; border:none; }
    input[type="range"]::-moz-range-track { height:6px; border-radius:3px; }
    .btn-choice { 
      padding: 16px 24px; border-radius: 16px; border: 2px solid var(--elevated); 
      background: var(--card); color: var(--muted); font-weight: 600; cursor: pointer; 
      transition: all 0.2s; font-size: 16px; width: 100%; text-align: left;
      display: flex; align-items: center; gap: 12px;
    }
    .btn-choice:hover { border-color: var(--gold); color: var(--text); transform: scale(1.02); }
    .btn-choice:active { transform: scale(0.98); }
    .btn-choice.active { border-color: var(--gold); background: var(--gold-soft); color: var(--gold); }
    .search-input:focus { border-color: var(--gold) !important; outline: none; }
    .rating-btn {
      width: 52px; height: 52px; border-radius: 16px; border: 2px solid var(--elevated);
      background: var(--card); color: var(--muted); font-size: 20px; cursor: pointer;
      transition: all 0.2s; display: flex; align-items: center; justify-content: center;
    }
    .rating-btn:hover { border-color: var(--gold); transform: scale(1.1); }
    .rating-btn.active { border-color: var(--gold); background: var(--gold); color: var(--bg); transform: scale(1.1); }
    .share-btn {
      padding: 14px 28px; border-radius: 50px; border: none;
      background: linear-gradient(135deg, var(--purple), var(--p1));
      color: white; font-weight: 700; cursor: pointer; font-size: 15px;
      transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px;
    }
    .share-btn:hover { transform: scale(1.05); box-shadow: 0 10px 30px rgba(168,85,247,0.4); }
    .watch-btn {
      padding: 12px 24px; border-radius: 50px; border: 2px solid var(--gold);
      background: transparent; color: var(--gold); font-weight: 700; cursor: pointer; font-size: 14px;
      transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px;
      text-decoration: none;
    }
    .watch-btn:hover { background: var(--gold); color: var(--bg); }
    /* Mobile responsive */
    @media (max-width: 640px) {
      .header-btn { position: static !important; margin-top: 12px; }
      .result-card-inner { flex-direction: column !important; text-align: center; }
      .result-card-inner > div:first-child { margin: 0 auto; }
      .result-poster { width: 140px !important; }
      .result-info { text-align: center; }
      .picks-grid { grid-template-columns: 1fr !important; }
      .vs-circle { display: none; }
      .partner-columns { flex-direction: column !important; gap: 16px !important; }
    }
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect } = React;

const API_KEY = '3f81cab7617ce7a5f47995d7d12a6512';
const TMDB = 'https://api.themoviedb.org/3';
const IMG = 'https://image.tmdb.org/t/p/w500';
const IMG_SM = 'https://image.tmdb.org/t/p/w200';

const VERDICT_QUOTES = [
  "All is fair in love and war... and movie night. ‚öîÔ∏è",
  "Don't worry, you'll get it next time. üòè",
  "The algorithm has spoken. No appeals. ‚öñÔ∏è",
  "This explains a lot, doesn't it? üëÄ",
  "We don't make the rules. Actually, we do. üé¨",
  "Statistically speaking, this was inevitable. üìä",
  "The couch remembers everything. üõãÔ∏è",
  "May the popcorn be buttery and the vibes be right. üçø",
  "Compromise: when nobody gets exactly what they want. üíï",
  "This decision was made with love, math, and chaos. üé≤"
];

// Deliberation Messages Component
const DeliberationMessages = () => {
  const [messageIndex, setMessageIndex] = useState(0);
  const messages = [
    { text: "Reviewing the evidence...", emoji: "üìã" },
    { text: "Analyzing taste profiles...", emoji: "üîç" },
    { text: "Consulting the ancient scrolls...", emoji: "üìú" },
    { text: "Weighing compromise factors...", emoji: "‚öñÔ∏è" },
    { text: "Checking who picked last time...", emoji: "üëÄ" },
    { text: "Calculating fairness quotient...", emoji: "üìä" },
    { text: "Almost there...", emoji: "‚ú®" },
    { text: "Rendering final judgment...", emoji: "üé¨" }
  ];

  useEffect(() => {
    const interval = setInterval(() => {
      setMessageIndex(prev => (prev + 1) % messages.length);
    }, 600);
    return () => clearInterval(interval);
  }, []);

  return (
    <div style={{animation:'fadeIn 0.3s ease-out'}}>
      <p style={{color:'var(--muted)',fontSize:'15px',marginBottom:'8px'}}>
        {messages[messageIndex].emoji} {messages[messageIndex].text}
      </p>
      <div style={{display:'flex',justifyContent:'center',gap:'6px',marginTop:'16px'}}>
        {[0,1,2,3,4].map(i => (
          <div key={i} style={{
            width:'8px',height:'8px',borderRadius:'50%',
            background: i <= messageIndex % 5 ? 'var(--gold)' : 'var(--elevated)',
            transition:'background 0.3s'
          }}/>
        ))}
      </div>
    </div>
  );
};

const GENRES = {
  28:{name:'Action',intensity:0.85,romance:0.25,comfort:0.35,cerebral:0.3},
  12:{name:'Adventure',intensity:0.7,romance:0.4,comfort:0.55,cerebral:0.4},
  16:{name:'Animation',intensity:0.35,romance:0.5,comfort:0.85,cerebral:0.4},
  35:{name:'Comedy',intensity:0.25,romance:0.6,comfort:0.9,cerebral:0.3},
  80:{name:'Crime',intensity:0.75,romance:0.3,comfort:0.3,cerebral:0.7},
  99:{name:'Documentary',intensity:0.2,romance:0.15,comfort:0.5,cerebral:0.95},
  18:{name:'Drama',intensity:0.5,romance:0.7,comfort:0.45,cerebral:0.65},
  10751:{name:'Family',intensity:0.2,romance:0.35,comfort:0.95,cerebral:0.25},
  14:{name:'Fantasy',intensity:0.55,romance:0.55,comfort:0.65,cerebral:0.5},
  36:{name:'History',intensity:0.45,romance:0.4,comfort:0.4,cerebral:0.85},
  27:{name:'Horror',intensity:0.95,romance:0.2,comfort:0.15,cerebral:0.4},
  10402:{name:'Music',intensity:0.4,romance:0.7,comfort:0.8,cerebral:0.35},
  9648:{name:'Mystery',intensity:0.65,romance:0.35,comfort:0.35,cerebral:0.9},
  10749:{name:'Romance',intensity:0.3,romance:1.0,comfort:0.7,cerebral:0.35},
  878:{name:'Sci-Fi',intensity:0.65,romance:0.35,comfort:0.45,cerebral:0.8},
  53:{name:'Thriller',intensity:0.9,romance:0.25,comfort:0.2,cerebral:0.75},
  10752:{name:'War',intensity:0.9,romance:0.35,comfort:0.2,cerebral:0.6},
  37:{name:'Western',intensity:0.65,romance:0.4,comfort:0.4,cerebral:0.4}
};

const fetchTMDB = async (endpoint) => {
  try {
    const sep = endpoint.includes('?') ? '&' : '?';
    const r = await fetch(`${TMDB}${endpoint}${sep}api_key=${API_KEY}`);
    if (!r.ok) throw new Error('API error');
    return r.json();
  } catch (e) { return null; }
};

const normalizeMovie = (m) => ({
  id: m.id, title: m.title, year: m.release_date?.split('-')[0] || 'TBA',
  rating: m.vote_average || 0, genre_ids: m.genre_ids || [],
  poster: m.poster_path ? `${IMG}${m.poster_path}` : null,
  posterSm: m.poster_path ? `${IMG_SM}${m.poster_path}` : null,
  overview: m.overview || ''
});

const ExpressionSlider = ({ value, onChange, color }) => {
  // 7 positions: 0-2 negative (red), 3 compromise (green), 4-6 positive (teal/gold)
  const labels = [
    'Absolutely not',
    'Not tonight',
    'Not for me',
    "We'd both like this",
    'I want this',
    'I really want this',
    "üî• TONIGHT'S PICK üî•"
  ];
  const labelIndex = value;
  const isCompromise = value === 3;
  const isMax = value === 6;
  
  // Color logic: red for negative (0-2), green for compromise (3), gold for high (5-6), teal otherwise
  let displayColor;
  if (value <= 2) displayColor = 'var(--p1)';
  else if (isCompromise) displayColor = '#4ADE80';
  else if (value >= 5) displayColor = 'var(--gold)';
  else displayColor = color;
  
  // Slider: center/compromise is at value 3 (50% position)
  // 0=0%, 1=16.7%, 2=33.3%, 3=50%, 4=66.7%, 5=83.3%, 6=100%
  const percent = (value / 6) * 100;
  const centerPoint = 50; // value 3 is the center/compromise point
  
  let gradient;
  if (value < 3) {
    // Left of center: red bar from current position to center (not from 0)
    gradient = `linear-gradient(to right, 
      #2a2a35 0%, 
      #2a2a35 ${percent}%, 
      var(--p1) ${percent}%, 
      var(--p1) ${centerPoint}%, 
      #2a2a35 ${centerPoint}%, 
      #2a2a35 100%)`;
  } else if (value === 3) {
    // At center (compromise): no bar, just gray track
    gradient = '#2a2a35';
  } else {
    // Right of center: colored bar extends from center to current position
    const fillColor = value >= 5 ? 'var(--gold)' : color;
    gradient = `linear-gradient(to right, 
      #2a2a35 0%, 
      #2a2a35 ${centerPoint}%, 
      ${fillColor} ${centerPoint}%, 
      ${fillColor} ${percent}%, 
      #2a2a35 ${percent}%, 
      #2a2a35 100%)`;
  }
  
  return (
    <div style={{marginTop:'10px'}}>
      <input type="range" min="0" max="6" value={value}
        onChange={e => onChange(+e.target.value)}
        style={{ 
          background: gradient,
          color: displayColor
        }}
      />
      <div style={{
        textAlign:'center',
        fontSize: value === 6 ? '9px' : '10px',
        color: displayColor,
        fontWeight:'700',
        marginTop:'4px',
        textTransform:'uppercase',
        letterSpacing:'0.5px',
        animation: value === 6 ? 'pulse 1s ease-in-out infinite' : 'none'
      }}>
        {labels[labelIndex]}
      </div>
    </div>
  );
};

const PickCard = ({ movie, expression, onExpressionChange, onRemove, color, index }) => {
  const isNegative = expression <= 2;
  const isCompromise = expression === 3;
  const isStrong = expression >= 5;
  // Border color: red for negative, green for compromise, gold for strong, otherwise partner color
  let borderColor = color;
  if (isNegative) borderColor = 'var(--p1)';
  else if (isCompromise) borderColor = '#4ADE80';
  else if (isStrong) borderColor = 'var(--gold)';
  
  return (
    <div style={{
      background:'var(--card)', borderRadius:'16px', padding:'14px',
      border:`2px solid ${borderColor}`, position:'relative',
      animation:`slideIn 0.3s ease-out ${index * 0.1}s both`,
      opacity: isNegative ? 0.85 : 1
    }}>
      <button onClick={onRemove} style={{
        position:'absolute', top:'-10px', right:'-10px', width:'26px', height:'26px',
        borderRadius:'50%', border:'none', background:'#444', color:'white',
        cursor:'pointer', fontSize:'14px', fontWeight:'bold',
        display:'flex', alignItems:'center', justifyContent:'center'
      }}>√ó</button>
      <div style={{display:'flex',gap:'12px',alignItems:'center'}}>
        {movie.poster ? (
          <img src={movie.posterSm || movie.poster} alt="" style={{width:'50px',height:'75px',objectFit:'cover',borderRadius:'10px',flexShrink:0,opacity: isNegative ? 0.7 : 1}} onError={(e) => e.target.style.display = 'none'} />
        ) : (
          <div style={{width:'50px',height:'75px',background:'var(--elevated)',borderRadius:'10px',display:'flex',alignItems:'center',justifyContent:'center',fontSize:'24px',flexShrink:0}}>üé¨</div>
        )}
        <div style={{flex:1,minWidth:0}}>
          <h4 style={{fontSize:'14px',fontWeight:'600',marginBottom:'2px',whiteSpace:'nowrap',overflow:'hidden',textOverflow:'ellipsis',color: isNegative ? 'var(--muted)' : 'inherit'}}>{movie.title}</h4>
          <p style={{fontSize:'11px',color:'var(--dim)'}}>{movie.year}</p>
          <ExpressionSlider value={expression} onChange={onExpressionChange} color={color} />
        </div>
      </div>
    </div>
  );
};

const MovieResult = ({ movie, onSelect, alreadyPicked }) => {
  const [hover, setHover] = useState(false);
  return (
    <div onClick={() => !alreadyPicked && onSelect(movie)}
      onMouseEnter={() => setHover(true)} onMouseLeave={() => setHover(false)}
      style={{
        display:'flex', gap:'12px', padding:'12px', borderRadius:'12px',
        background: hover && !alreadyPicked ? 'var(--elevated)' : 'transparent',
        cursor: alreadyPicked ? 'not-allowed' : 'pointer',
        opacity: alreadyPicked ? 0.5 : 1, transition:'all 0.2s'
      }}>
      {movie.poster ? (
        <img src={movie.posterSm || movie.poster} alt="" style={{width:'44px',height:'66px',objectFit:'cover',borderRadius:'8px',flexShrink:0}} onError={(e) => e.target.style.display = 'none'} />
      ) : (
        <div style={{width:'44px',height:'66px',background:'var(--card)',borderRadius:'8px',display:'flex',alignItems:'center',justifyContent:'center',fontSize:'18px',flexShrink:0}}>üé¨</div>
      )}
      <div style={{flex:1,minWidth:0}}>
        <h4 style={{fontSize:'14px',fontWeight:'600',marginBottom:'3px'}}>{movie.title}</h4>
        <p style={{fontSize:'12px',color:'var(--dim)'}}>{movie.year}{movie.rating > 0 && ` ‚Ä¢ ‚òÖ ${movie.rating.toFixed(1)}`}</p>
        {alreadyPicked && <span style={{fontSize:'10px',color:'var(--gold)'}}>Already picked</span>}
      </div>
    </div>
  );
};

const PartnerColumn = ({ name, emoji, color, picks, onAddPick, onRemovePick, onExpressionChange, allPicks, movies, onSearch, loading, onEmptySlotClick, player }) => {
  const [query, setQuery] = useState('');
  const [showResults, setShowResults] = useState(false);
  const [searchResults, setSearchResults] = useState([]);
  const [searching, setSearching] = useState(false);
  const inputRef = React.useRef(null);

  const doSearch = async (q) => {
    if (!q.trim()) return;
    setSearching(true);
    const results = await onSearch(q);
    setSearchResults(results);
    setSearching(false);
    setShowResults(true);
  };

  const handleSelect = (movie) => {
    if (picks.length < 4) {
      onAddPick(movie);
      setQuery('');
      setShowResults(false);
      setSearchResults([]);
    }
  };
  
  const handleEmptySlotClick = () => {
    if (onEmptySlotClick) {
      onEmptySlotClick();
    } else if (inputRef.current) {
      inputRef.current.focus();
      setShowResults(true);
    }
  };

  const displayResults = query.trim() && searchResults.length > 0 ? searchResults : movies.slice(0, 10);
  // Only block movies THIS player has already picked, not the partner's picks
  const currentPlayerPicks = player === 1 ? allPicks.p1 : allPicks.p2;
  const pickedIds = new Set(Object.keys(currentPlayerPicks || {}).map(String));
  const isComplete = picks.length >= 2;

  return (
    <div style={{
      flex:1, minWidth:'280px', background:'var(--card)', borderRadius:'24px',
      padding:'20px', border:`3px solid ${isComplete ? color : 'var(--elevated)'}`,
      boxShadow: isComplete ? `0 0 30px ${color}30` : 'none', transition:'all 0.3s'
    }}>
      <div style={{textAlign:'center',marginBottom:'16px'}}>
        <div style={{fontSize:'40px',marginBottom:'8px'}}>{emoji}</div>
        <h2 className="space" style={{fontSize:'20px',fontWeight:'700',color,marginBottom:'4px'}}>{name}</h2>
        <p style={{fontSize:'13px',color:'var(--muted)'}}>{picks.length}/4 picks {isComplete && '‚úì'}</p>
      </div>
      <div style={{display:'flex',flexDirection:'column',gap:'12px',marginBottom:'16px',minHeight:'260px'}}>
        {picks.map((pick, i) => (
          <PickCard key={pick.movie.id} movie={pick.movie} expression={pick.expr}
            onExpressionChange={(val) => onExpressionChange(pick.movie.id, val)}
            onRemove={() => onRemovePick(pick.movie.id)} color={color} index={i} />
        ))}
        {picks.length < 4 && [...Array(4 - picks.length)].map((_, i) => (
          <div 
            key={`empty-${i}`} 
            onClick={handleEmptySlotClick}
            style={{
              height:'103px', borderRadius:'16px', border:`2px dashed ${i === 0 && picks.length < 1 ? color+'60' : 'var(--elevated)'}`,
              display:'flex',alignItems:'center',justifyContent:'center',color:'var(--dim)',fontSize:'13px',
              cursor:'pointer',transition:'all 0.2s',
              background: 'transparent'
            }}
            onMouseOver={(e) => {e.currentTarget.style.borderColor = color; e.currentTarget.style.background = 'rgba(255,255,255,0.02)';}}
            onMouseOut={(e) => {e.currentTarget.style.borderColor = i === 0 && picks.length < 1 ? color+'60' : 'var(--elevated)'; e.currentTarget.style.background = 'transparent';}}
          >
            {i === 0 && picks.length === 0 ? '+ Pick at least 1...' : '+ Optional...'}
          </div>
        ))}
      </div>
      {picks.length < 4 && (
        <div style={{position:'relative'}}>
          <form onSubmit={(e) => { e.preventDefault(); doSearch(query); }}>
            <input 
              ref={inputRef}
              value={query} 
              onChange={(e) => { setQuery(e.target.value); if (!e.target.value) setShowResults(true); }}
              onFocus={() => setShowResults(true)} 
              placeholder="Search movies..." 
              className="search-input"
              style={{width:'100%',padding:'14px 16px',borderRadius:'14px',border:'2px solid var(--elevated)',background:'var(--bg)',color:'var(--text)',fontSize:'14px'}} 
            />
          </form>
          {showResults && (
            <div style={{position:'absolute',top:'100%',left:0,right:0,marginTop:'8px',background:'var(--card)',borderRadius:'14px',maxHeight:'280px',overflowY:'auto',zIndex:100,boxShadow:'0 15px 50px rgba(0,0,0,0.5)',border:'1px solid var(--elevated)'}}>
              {searching || loading ? (
                <div style={{padding:'20px',textAlign:'center',color:'var(--muted)',fontSize:'14px'}}>
                  <div style={{width:'24px',height:'24px',border:'3px solid var(--elevated)',borderTopColor:color,borderRadius:'50%',animation:'spin 0.8s linear infinite',margin:'0 auto 10px'}}/>
                  {searching ? 'Searching...' : 'Loading...'}
                </div>
              ) : displayResults.length > 0 ? (
                displayResults.map(m => <MovieResult key={m.id} movie={m} onSelect={handleSelect} alreadyPicked={pickedIds.has(String(m.id))} />)
              ) : query.trim() ? <div style={{padding:'20px',textAlign:'center',color:'var(--muted)',fontSize:'14px'}}>No results</div> : null}
            </div>
          )}
        </div>
      )}
    </div>
  );
};

// Sentiment Tag Calculator (scale: 0-2 negative, 3 compromise, 4-6 positive)
const getSentimentTag = (picks) => {
  if (picks.length === 0) return null;
  
  const expressions = picks.map(p => p.expr);
  const avg = expressions.reduce((a, b) => a + b, 0) / expressions.length;
  const hasExtreme = expressions.some(e => e >= 6 || e <= 1);
  const hasNegative = expressions.some(e => e <= 2);
  const hasStrong = expressions.some(e => e >= 5);
  const allStrong = expressions.every(e => e >= 5);
  const allNegative = expressions.every(e => e <= 2);
  const allMild = expressions.every(e => e >= 2 && e <= 4);
  const allCompromise = expressions.every(e => e === 3);
  const variance = expressions.length > 1 ? 
    expressions.reduce((sum, e) => sum + Math.pow(e - avg, 2), 0) / expressions.length : 0;
  
  // Fairness tags
  if (allCompromise && picks.length >= 2) return { emoji: 'üèÜ', text: 'Compromiser', color: '#4ADE80' };
  if (allMild && picks.length >= 2) return { emoji: 'ü§ù', text: 'Flexible', color: '#4ADE80' };
  if (hasExtreme && variance < 1 && picks.length >= 2) return { emoji: '‚ö†Ô∏è', text: 'Digging in', color: 'var(--gold)' };
  if (hasStrong && !allStrong && picks.length >= 2) return { emoji: 'üß†', text: 'Strategic', color: 'var(--purple)' };
  
  // Stance tags
  if (allStrong || (hasExtreme && avg > 4)) return { emoji: 'üòà', text: 'Bold stance', color: 'var(--p1)' };
  if (hasStrong && hasNegative) return { emoji: '‚öñÔ∏è', text: 'Balanced', color: 'var(--gold)' };
  
  // Pattern tags  
  if (variance > 4) return { emoji: 'üé¢', text: 'All over the place', color: 'var(--purple)' };
  if (variance < 0.5 && picks.length >= 2) return { emoji: 'üîÅ', text: 'Consistent', color: 'var(--p2)' };
  if (hasStrong && avg < 3.5) return { emoji: 'üéØ', text: 'Selective', color: 'var(--gold)' };
  
  // Tone tags
  if (allStrong) return { emoji: 'üî•', text: 'All in', color: 'var(--p1)' };
  if (allNegative) return { emoji: '‚ùÑÔ∏è', text: 'Not feeling it', color: '#60A5FA' };
  if (allMild) return { emoji: 'üåô', text: 'Chill vibes', color: 'var(--muted)' };
  
  return null;
};

// Mobile Turn-Based Column Component
const MobileTurnColumn = ({ turn, picks, onAddPick, onRemovePick, onExpressionChange, movies, onSearch, loading, allPicks, mobileSearchOpen, setMobileSearchOpen }) => {
  const [query, setQuery] = useState('');
  const [searchResults, setSearchResults] = useState([]);
  const [searching, setSearching] = useState(false);
  
  const color = turn === 1 ? 'var(--p2)' : 'var(--p1)';
  const emoji = turn === 1 ? 'üòá' : 'üòà';

  const doSearch = async (q) => {
    if (!q.trim()) return;
    setSearching(true);
    const results = await onSearch(q);
    setSearchResults(results);
    setSearching(false);
  };

  const handleSelect = (movie) => {
    if (picks.length < 4) {
      onAddPick(movie);
      setQuery('');
      setSearchResults([]);
      setMobileSearchOpen(false);
    }
  };

  const displayResults = query.trim() && searchResults.length > 0 ? searchResults : movies.slice(0, 15);
  // Only block movies the CURRENT player has already picked, not the partner's picks
  const currentPlayerPicks = turn === 1 ? allPicks.p1 : allPicks.p2;
  const pickedIds = new Set(Object.keys(currentPlayerPicks || {}).map(String));

  return (
    <div>
      {/* Pick Slots - parent div handles scrolling */}
      <div style={{display:'flex',flexDirection:'column',gap:'12px',paddingBottom:'16px'}}>
        {/* Render picks and empty slots - always show all 4 */}
        {[0, 1, 2, 3].map(i => {
          const pick = picks[i];
          if (pick) {
            return (
              <PickCard key={pick.movie.id} movie={pick.movie} expression={pick.expr}
                onExpressionChange={(val) => onExpressionChange(pick.movie.id, val)}
                onRemove={() => onRemovePick(pick.movie.id)} color={color} index={i} />
            );
          } else {
            // Empty slot - always show all 4
            const isRequired = picks.length === 0 && i === 0;
            return (
              <div 
                key={`empty-${i}`} 
                onClick={() => setMobileSearchOpen(true)}
                style={{
                  minHeight:'65px', borderRadius:'16px', 
                  border: `2px dashed ${isRequired ? color : 'var(--elevated)'}`,
                  display:'flex',alignItems:'center',justifyContent:'center',
                  color: isRequired ? color : 'var(--dim)',
                  fontSize:'13px',cursor:'pointer',
                  background: 'transparent',
                  transition:'all 0.2s'
                }}
              >
                <span>+ Tap to add movie {isRequired ? '(required)' : '(optional)'}</span>
              </div>
            );
          }
        })}
      </div>
      
      {/* Search Modal for Mobile */}
      {mobileSearchOpen && (
        <div style={{
          position:'fixed',inset:0,background:'var(--bg)',zIndex:1000,
          display:'flex',flexDirection:'column',animation:'fadeIn 0.2s ease-out'
        }}>
          <div style={{padding:'16px',borderBottom:'1px solid var(--elevated)'}}>
            <div style={{display:'flex',gap:'12px',alignItems:'center'}}>
              <button onClick={() => {setMobileSearchOpen(false);setQuery('');setSearchResults([]);}} style={{
                width:'40px',height:'40px',borderRadius:'50%',border:'none',
                background:'var(--elevated)',color:'var(--muted)',fontSize:'20px',cursor:'pointer',
                display:'flex',alignItems:'center',justifyContent:'center',flexShrink:0
              }}>‚Üê</button>
              <form onSubmit={(e) => { e.preventDefault(); doSearch(query); }} style={{flex:1}}>
                <input 
                  value={query} 
                  onChange={(e) => { setQuery(e.target.value); if (e.target.value.length > 2) doSearch(e.target.value); }}
                  placeholder="Search for a movie..." 
                  autoFocus
                  className="search-input"
                  style={{
                    width:'100%',padding:'12px 16px',borderRadius:'12px',
                    border:'2px solid var(--elevated)',background:'var(--card)',
                    color:'var(--text)',fontSize:'16px'
                  }} 
                />
              </form>
            </div>
          </div>
          
          <div style={{flex:1,overflowY:'auto',padding:'8px 0'}}>
            {searching || loading ? (
              <div style={{padding:'40px',textAlign:'center',color:'var(--muted)'}}>
                <div style={{width:'32px',height:'32px',border:'3px solid var(--elevated)',borderTopColor:color,borderRadius:'50%',animation:'spin 0.8s linear infinite',margin:'0 auto 12px'}}/>
                Searching...
              </div>
            ) : displayResults.length > 0 ? (
              displayResults.map(m => (
                <div 
                  key={m.id}
                  onClick={() => !pickedIds.has(String(m.id)) && handleSelect(m)}
                  style={{
                    display:'flex',gap:'14px',padding:'14px 16px',
                    borderBottom:'1px solid var(--elevated)',
                    opacity: pickedIds.has(String(m.id)) ? 0.5 : 1,
                    cursor: pickedIds.has(String(m.id)) ? 'not-allowed' : 'pointer'
                  }}
                >
                  {m.poster ? (
                    <img src={m.posterSm || m.poster} alt="" style={{width:'50px',height:'75px',objectFit:'cover',borderRadius:'8px',flexShrink:0}} />
                  ) : (
                    <div style={{width:'50px',height:'75px',background:'var(--card)',borderRadius:'8px',display:'flex',alignItems:'center',justifyContent:'center',fontSize:'20px',flexShrink:0}}>üé¨</div>
                  )}
                  <div style={{flex:1,minWidth:0}}>
                    <h4 style={{fontSize:'15px',fontWeight:'600',marginBottom:'4px'}}>{m.title}</h4>
                    <p style={{fontSize:'13px',color:'var(--dim)'}}>{m.year}{m.rating > 0 && ` ‚Ä¢ ‚òÖ ${m.rating.toFixed(1)}`}</p>
                    {pickedIds.has(String(m.id)) && <span style={{fontSize:'11px',color:'var(--gold)'}}>Already picked</span>}
                  </div>
                </div>
              ))
            ) : query.trim() ? (
              <div style={{padding:'40px',textAlign:'center',color:'var(--muted)'}}>No results found</div>
            ) : (
              <div style={{padding:'20px',textAlign:'center',color:'var(--dim)',fontSize:'13px'}}>
                Start typing to search for movies
              </div>
            )}
          </div>
        </div>
      )}
    </div>
  );
};

const ResultMovieCard = ({ movie, score, rank, isWinner, isDiscovery }) => (
  <div style={{
    background: isWinner ? 'linear-gradient(135deg,var(--card),var(--elevated))' : 'var(--card)',
    borderRadius: isWinner ? '24px' : '16px', padding: isWinner ? '20px' : '14px',
    border: isWinner ? '3px solid var(--gold)' : 'none',
    boxShadow: isWinner ? '0 0 60px rgba(255,217,61,0.2)' : '0 4px 20px rgba(0,0,0,0.2)',
    animation: `reveal 0.5s ease-out ${rank * 0.15}s both`
  }}>
    {isWinner ? (
      <div style={{display:'flex',flexDirection:'column',alignItems:'center',textAlign:'center'}}>
        <div style={{fontSize:'12px',color:'var(--gold)',fontWeight:'700',marginBottom:'12px',textTransform:'uppercase',letterSpacing:'2px'}}>üé¨ THE VERDICT</div>
        
        {/* Discovery message when neither person picked this */}
        {isDiscovery && (
          <div style={{
            background:'linear-gradient(135deg, rgba(168,85,247,0.15), rgba(255,107,107,0.15))',
            borderRadius:'12px',padding:'12px 16px',marginBottom:'16px',maxWidth:'280px'
          }}>
            <p style={{fontSize:'13px',color:'var(--purple)',fontStyle:'italic',lineHeight:'1.5'}}>
              üîÆ Neither of you picked this one... but the algorithm thinks you'll both love it. Trust the process.
            </p>
          </div>
        )}
        
        <div style={{borderRadius:'16px',overflow:'hidden',marginBottom:'16px',boxShadow:'0 8px 30px rgba(0,0,0,0.4)',maxWidth:'180px'}}>
          {movie.poster ? (
            <img src={movie.poster} alt={movie.title} style={{width:'100%',display:'block'}} onError={(e) => e.target.style.display = 'none'} />
          ) : (
            <div style={{width:'180px',height:'270px',background:'var(--elevated)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:'48px'}}>üé¨</div>
          )}
        </div>
        <h3 className="space" style={{fontSize:'22px',fontWeight:'700',marginBottom:'10px',lineHeight:1.2}}>{movie.title}</h3>
        <div style={{display:'flex',gap:'8px',marginBottom:'12px',flexWrap:'wrap',justifyContent:'center'}}>
          {movie.rating > 0 && <span style={{padding:'4px 12px',borderRadius:'20px',background:'var(--bg)',fontSize:'12px',fontWeight:'600'}}>‚òÖ {movie.rating.toFixed(1)}</span>}
          <span style={{padding:'4px 12px',borderRadius:'20px',background:'var(--bg)',fontSize:'12px'}}>{movie.year}</span>
        </div>
        <div style={{padding:'12px 20px',borderRadius:'14px',background:'linear-gradient(135deg,rgba(255,107,107,0.15),rgba(78,205,196,0.15))',marginBottom:'14px'}}>
          <span style={{fontSize:'12px',color:'var(--muted)',marginRight:'8px'}}>Match:</span>
          <span className="space" style={{fontSize:'28px',fontWeight:'700',color:'var(--gold)'}}>{score}%</span>
        </div>
        {movie.overview && <p style={{fontSize:'12px',color:'var(--muted)',lineHeight:'1.5',marginBottom:'16px'}}>{movie.overview.slice(0,140)}...</p>}
        <div style={{display:'flex',gap:'10px',flexWrap:'wrap',justifyContent:'center'}}>
          <a href={`https://www.justwatch.com/us/search?q=${encodeURIComponent(movie.title)}`} target="_blank" rel="noopener noreferrer" style={{
            padding:'12px 20px',borderRadius:'14px',background:'var(--gold)',color:'var(--bg)',
            fontSize:'13px',fontWeight:'700',textDecoration:'none',display:'inline-flex',alignItems:'center',gap:'6px'
          }}>
            üì∫ Where to Watch
          </a>
          <a href={`https://www.themoviedb.org/movie/${movie.id}`} target="_blank" rel="noopener noreferrer" style={{
            padding:'12px 20px',borderRadius:'14px',border:'2px solid var(--elevated)',background:'transparent',color:'var(--muted)',
            fontSize:'13px',fontWeight:'600',textDecoration:'none',display:'inline-flex',alignItems:'center',gap:'6px'
          }}>
            ‚ÑπÔ∏è More Info
          </a>
        </div>
      </div>
    ) : (
      <div style={{display:'flex',gap:'12px',alignItems:'center'}}>
        <div style={{width:'28px',height:'28px',borderRadius:'50%',flexShrink:0,
          background: rank === 2 ? 'linear-gradient(135deg,#C0C0C0,#888)' : rank === 3 ? 'linear-gradient(135deg,#CD7F32,#8B4513)' : 'var(--elevated)',
          display:'flex',alignItems:'center',justifyContent:'center',fontWeight:'700',color:'white',fontSize:'12px'}}>{rank}</div>
        <div style={{borderRadius:'10px',overflow:'hidden',flexShrink:0,width:'50px'}}>
          {movie.poster ? (
            <img src={movie.poster} alt={movie.title} style={{width:'50px',display:'block'}} onError={(e) => e.target.style.display = 'none'} />
          ) : (
            <div style={{width:'50px',height:'75px',background:'var(--elevated)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:'18px'}}>üé¨</div>
          )}
        </div>
        <div style={{flex:1,minWidth:0}}>
          <h3 className="space" style={{fontSize:'13px',fontWeight:'600',marginBottom:'4px',whiteSpace:'nowrap',overflow:'hidden',textOverflow:'ellipsis'}}>{movie.title}</h3>
          <div style={{display:'flex',gap:'6px',alignItems:'center',flexWrap:'wrap'}}>
            {movie.rating > 0 && <span style={{fontSize:'11px',color:'var(--dim)'}}>‚òÖ {movie.rating.toFixed(1)}</span>}
            <span style={{fontSize:'11px',color:'var(--dim)'}}>{movie.year}</span>
            <span style={{fontSize:'14px',fontWeight:'700',color:'var(--gold)',marginLeft:'auto'}}>{score}%</span>
          </div>
        </div>
      </div>
    )}
  </div>
);

const RatingButtons = ({ value, onChange, color }) => {
  const emojis = ['üò¥', 'üòê', 'üôÇ', 'üòä', 'ü§©'];
  const labels = ['hated it', 'meh', 'it was ok', 'liked it', 'loved it'];
  return (
    <div>
      <div style={{display:'flex',gap:'10px',justifyContent:'center'}}>
        {[1,2,3,4,5].map(n => (
          <button key={n} className={`rating-btn ${value === n ? 'active' : ''}`} onClick={() => onChange(n)}
            style={value === n ? {borderColor: color, background: color, color: 'var(--bg)'} : {}}>
            {emojis[n-1]}
          </button>
        ))}
      </div>
      {value && <p style={{textAlign:'center',fontSize:'12px',color,marginTop:'8px',fontWeight:'600'}}>{labels[value-1]}</p>}
    </div>
  );
};

const LastMovieSearch = ({ value, onChange, movies, onSearch }) => {
  const [query, setQuery] = useState('');
  const [showResults, setShowResults] = useState(false);
  const [searchResults, setSearchResults] = useState([]);
  const [searching, setSearching] = useState(false);

  const doSearch = async (q) => {
    if (!q.trim()) return;
    setSearching(true);
    const results = await onSearch(q);
    setSearchResults(results);
    setSearching(false);
    setShowResults(true);
  };

  if (value) {
    return (
      <div style={{display:'flex',alignItems:'center',gap:'14px',padding:'14px',background:'var(--elevated)',borderRadius:'16px'}}>
        {value.poster && <img src={value.posterSm || value.poster} alt="" style={{width:'50px',height:'75px',objectFit:'cover',borderRadius:'10px'}} />}
        <div style={{flex:1}}>
          <p style={{fontWeight:'600',fontSize:'15px'}}>{value.title}</p>
          <p style={{fontSize:'13px',color:'var(--dim)'}}>{value.year}</p>
        </div>
        <button onClick={() => onChange(null)} style={{padding:'8px 14px',borderRadius:'10px',border:'none',background:'var(--card)',color:'var(--muted)',cursor:'pointer',fontSize:'13px',fontWeight:'600'}}>Change</button>
      </div>
    );
  }

  const displayResults = query.trim() && searchResults.length > 0 ? searchResults : movies.slice(0, 8);

  return (
    <div style={{position:'relative'}}>
      <form onSubmit={(e) => { e.preventDefault(); doSearch(query); }}>
        <input value={query} onChange={(e) => { setQuery(e.target.value); setShowResults(true); }}
          onFocus={() => setShowResults(true)} placeholder="Search for the movie..." className="search-input"
          style={{width:'100%',padding:'16px 18px',borderRadius:'14px',border:'2px solid var(--elevated)',background:'var(--bg)',color:'var(--text)',fontSize:'15px'}} />
      </form>
      {showResults && (
        <div style={{position:'absolute',top:'100%',left:0,right:0,marginTop:'8px',background:'var(--card)',borderRadius:'14px',maxHeight:'260px',overflowY:'auto',zIndex:100,boxShadow:'0 15px 50px rgba(0,0,0,0.5)',border:'1px solid var(--elevated)'}}>
          {searching ? (
            <div style={{padding:'20px',textAlign:'center',color:'var(--muted)',fontSize:'14px'}}>
              <div style={{width:'24px',height:'24px',border:'3px solid var(--elevated)',borderTopColor:'var(--gold)',borderRadius:'50%',animation:'spin 0.8s linear infinite',margin:'0 auto 10px'}}/>Searching...
            </div>
          ) : displayResults.length > 0 ? displayResults.map(m => (
            <MovieResult key={m.id} movie={m} onSelect={(movie) => { onChange(movie); setQuery(''); setShowResults(false); }} alreadyPicked={false} />
          )) : query.trim() ? <div style={{padding:'20px',textAlign:'center',color:'var(--muted)',fontSize:'14px'}}>No results</div> : null}
        </div>
      )}
    </div>
  );
};

// Fairness Bar Component
const FairnessBar = ({ p1Percent, p2Percent }) => (
  <div style={{background:'var(--card)',borderRadius:'20px',padding:'24px',marginTop:'24px',animation:'fadeIn 0.5s ease-out 0.5s both'}}>
    <h3 className="space" style={{fontSize:'14px',fontWeight:'700',marginBottom:'16px',textAlign:'center',color:'var(--muted)',textTransform:'uppercase',letterSpacing:'1px'}}>
      ‚öñÔ∏è Movie Night Balance
    </h3>
    <div style={{display:'flex',flexDirection:'column',gap:'12px'}}>
      <div>
        <div style={{display:'flex',justifyContent:'space-between',marginBottom:'6px'}}>
          <span style={{fontSize:'13px',fontWeight:'600'}}>üòá You</span>
          <span style={{fontSize:'13px',color:'var(--p2)',fontWeight:'700'}}>{p1Percent}%</span>
        </div>
        <div style={{height:'12px',background:'var(--elevated)',borderRadius:'6px',overflow:'hidden'}}>
          <div style={{height:'100%',background:'linear-gradient(90deg,var(--p2),var(--p2-soft))',width:`${p1Percent}%`,borderRadius:'6px',transition:'width 1s ease-out'}}/>
        </div>
      </div>
      <div>
        <div style={{display:'flex',justifyContent:'space-between',marginBottom:'6px'}}>
          <span style={{fontSize:'13px',fontWeight:'600'}}>üòà Them</span>
          <span style={{fontSize:'13px',color:'var(--p1)',fontWeight:'700'}}>{p2Percent}%</span>
        </div>
        <div style={{height:'12px',background:'var(--elevated)',borderRadius:'6px',overflow:'hidden'}}>
          <div style={{height:'100%',background:'linear-gradient(90deg,var(--p1),var(--p1-soft))',width:`${p2Percent}%`,borderRadius:'6px',transition:'width 1s ease-out'}}/>
        </div>
      </div>
    </div>
    <p style={{textAlign:'center',fontSize:'12px',color:'var(--dim)',marginTop:'14px',fontStyle:'italic'}}>
      {p1Percent > p2Percent ? "Looking good for you tonight üòè" : p2Percent > p1Percent ? "They've been getting their way... üëÄ" : "Perfectly balanced, as all things should be ‚ú®"}
    </p>
  </div>
);

const App = () => {
  const [phase, setPhase] = useState('q1');
  const [movies, setMovies] = useState([]);
  const [loading, setLoading] = useState(true);
  const [p1Picks, setP1Picks] = useState({});
  const [p2Picks, setP2Picks] = useState({});
  const [lastPicker, setLastPicker] = useState(null);
  const [lastMovieRatingP1, setLastMovieRatingP1] = useState(null);
  const [lastMovieRatingP2, setLastMovieRatingP2] = useState(null);
  const [lastMovie, setLastMovie] = useState(null);
  const [result, setResult] = useState(null);
  const [cache, setCache] = useState({});
  const [randomQuotes, setRandomQuotes] = useState([]);
  const [fairnessScore, setFairnessScore] = useState({ p1: 50, p2: 50 });
  const [showHowItWorks, setShowHowItWorks] = useState(false);
  const [showSignUp, setShowSignUp] = useState(false);
  const [showLogin, setShowLogin] = useState(false);
  const [user, setUser] = useState(null);
  const [authEmail, setAuthEmail] = useState('');
  const [authPassword, setAuthPassword] = useState('');
  const [authError, setAuthError] = useState('');
  const [authSuccess, setAuthSuccess] = useState('');
  const [waitlistQuestion, setWaitlistQuestion] = useState('');
  const [waitlistMessage, setWaitlistMessage] = useState('');
  
  // Mobile turn-based picking
  const [isMobile, setIsMobile] = useState(false);
  const [currentTurn, setCurrentTurn] = useState(1); // 1 or 2
  const [showHandoff, setShowHandoff] = useState(false);
  const [mobileSearchOpen, setMobileSearchOpen] = useState(false);
  
  // Check if mobile on mount
  useEffect(() => {
    const checkMobile = () => setIsMobile(window.innerWidth <= 640);
    checkMobile();
    window.addEventListener('resize', checkMobile);
    return () => window.removeEventListener('resize', checkMobile);
  }, []);

  useEffect(() => {
    const load = async () => {
      setLoading(true);
      try {
        const [d1, d2, d3] = await Promise.all([
          fetchTMDB('/movie/popular?language=en-US&page=1'),
          fetchTMDB('/movie/top_rated?language=en-US&page=1'),
          fetchTMDB('/movie/now_playing?language=en-US&page=1')
        ]);
        const all = [...(d1?.results || []), ...(d2?.results || []), ...(d3?.results || [])];
        const unique = [...new Map(all.map(m => [m.id, m])).values()];
        const normalized = unique.map(normalizeMovie);
        setMovies(normalized);
        normalized.forEach(m => setCache(prev => ({...prev, [m.id]: m})));
      } catch (e) {}
      setLoading(false);
    };
    load();
  }, []);

  const search = async (query) => {
    try {
      const data = await fetchTMDB(`/search/movie?query=${encodeURIComponent(query)}&language=en-US&page=1`);
      if (data?.results) {
        const normalized = data.results.map(normalizeMovie);
        normalized.forEach(m => setCache(prev => ({...prev, [m.id]: m})));
        return normalized;
      }
    } catch (e) {}
    return [];
  };

  const addPick = (movie, partner) => {
    const setPicks = partner === 1 ? setP1Picks : setP2Picks;
    setPicks(prev => Object.keys(prev).length >= 4 ? prev : {...prev, [movie.id]: {movie, expr: 3}});
    setCache(prev => ({...prev, [movie.id]: movie}));
  };

  const removePick = (movieId, partner) => {
    const setPicks = partner === 1 ? setP1Picks : setP2Picks;
    setPicks(prev => { const {[movieId]: _, ...rest} = prev; return rest; });
  };

  const setExpr = (movieId, val, partner) => {
    const setPicks = partner === 1 ? setP1Picks : setP2Picks;
    setPicks(prev => ({...prev, [movieId]: {...prev[movieId], expr: val}}));
  };

  const p1Count = Object.keys(p1Picks).length;
  const p2Count = Object.keys(p2Picks).length;
  const canFindMatch = p1Count >= 1 && p2Count >= 1;

  const findMatch = async () => {
    setPhase('calculating');
    
    const shuffled = [...VERDICT_QUOTES].sort(() => Math.random() - 0.5);
    setRandomQuotes(shuffled.slice(0, 2));

    // Calculate fairness display (not the actual algorithm weights)
    let displayP1 = 50, displayP2 = 50;
    if (lastPicker === 'p1') { displayP1 = 35; displayP2 = 65; }
    else if (lastPicker === 'p2') { displayP1 = 65; displayP2 = 35; }
    if (lastMovieRatingP1 && lastMovieRatingP2) {
      if (lastPicker === 'p1' && lastMovieRatingP2 <= 2) { displayP1 = 25; displayP2 = 75; }
      else if (lastPicker === 'p2' && lastMovieRatingP1 <= 2) { displayP1 = 75; displayP2 = 25; }
    }
    setFairnessScore({ p1: displayP1, p2: displayP2 });

    let fairnessP1 = 1.0, fairnessP2 = 1.0;
    if (lastPicker === 'p1') {
      fairnessP1 = 0.7; fairnessP2 = 1.3;
      if (lastMovieRatingP2 && lastMovieRatingP2 <= 2) { fairnessP1 = 0.5; fairnessP2 = 1.5; }
      if (lastMovieRatingP1 >= 4 && lastMovieRatingP2 >= 4) { fairnessP1 = 0.9; fairnessP2 = 1.1; }
    } else if (lastPicker === 'p2') {
      fairnessP1 = 1.3; fairnessP2 = 0.7;
      if (lastMovieRatingP1 && lastMovieRatingP1 <= 2) { fairnessP1 = 1.5; fairnessP2 = 0.5; }
      if (lastMovieRatingP1 >= 4 && lastMovieRatingP2 >= 4) { fairnessP1 = 1.1; fairnessP2 = 0.9; }
    }

    const buildProfile = (picks, multiplier) => {
      const p = { genres: {}, intensity: 0, romance: 0, comfort: 0, cerebral: 0, totalW: 0 };
      Object.values(picks).forEach(({movie, expr}) => {
        // Only include positive preferences (3+) in profile building
        if (expr >= 3) {
          const w = ((expr - 2) * (expr - 2)) * multiplier; // Normalize: 3->1, 4->4, 5->9, 6->16
          p.totalW += w;
          (movie.genre_ids || []).forEach(gid => {
            const g = GENRES[gid];
            if (g) {
              p.genres[gid] = (p.genres[gid] || 0) + w;
              p.intensity += g.intensity * w; p.romance += g.romance * w;
              p.comfort += g.comfort * w; p.cerebral += g.cerebral * w;
            }
          });
        }
        // Negative preferences (0-2) reduce genre weights
        if (expr <= 2) {
          const w = ((3 - expr) * 0.5) * multiplier; // 0->1.5, 1->1, 2->0.5
          (movie.genre_ids || []).forEach(gid => {
            const g = GENRES[gid];
            if (g) {
              p.genres[gid] = (p.genres[gid] || 0) - w;
            }
          });
        }
      });
      if (p.totalW > 0) {
        p.intensity /= p.totalW; p.romance /= p.totalW; p.comfort /= p.totalW; p.cerebral /= p.totalW;
        Object.keys(p.genres).forEach(g => p.genres[g] /= p.totalW);
      }
      return p;
    };

    const prof1 = buildProfile(p1Picks, fairnessP1);
    const prof2 = buildProfile(p2Picks, fairnessP2);

    const center = {
      intensity: (prof1.intensity + prof2.intensity) / 2, romance: (prof1.romance + prof2.romance) / 2,
      comfort: (prof1.comfort + prof2.comfort) / 2, cerebral: (prof1.cerebral + prof2.cerebral) / 2, genres: {}
    };
    const allG = new Set([...Object.keys(prof1.genres), ...Object.keys(prof2.genres)]);
    allG.forEach(g => center.genres[g] = ((prof1.genres[g]||0) + (prof2.genres[g]||0)) / 2);

    // Find top genres from both profiles for better discovery
    const topGenres = Object.entries(center.genres)
      .filter(([_, w]) => w > 0)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 3)
      .map(([g]) => g);

    try {
      // Fetch many more movies for better recommendations
      const fetchPromises = [
        fetchTMDB('/movie/popular?language=en-US&page=2'),
        fetchTMDB('/movie/popular?language=en-US&page=3'),
        fetchTMDB('/movie/popular?language=en-US&page=4'),
        fetchTMDB('/movie/top_rated?language=en-US&page=2'),
        fetchTMDB('/movie/top_rated?language=en-US&page=3'),
        fetchTMDB('/movie/now_playing?language=en-US&page=2'),
        fetchTMDB('/trending/movie/week?language=en-US'),
      ];
      
      // Also fetch movies by the top genres they both like
      topGenres.forEach(gid => {
        fetchPromises.push(fetchTMDB(`/discover/movie?with_genres=${gid}&sort_by=popularity.desc&language=en-US&page=1`));
        fetchPromises.push(fetchTMDB(`/discover/movie?with_genres=${gid}&sort_by=vote_average.desc&vote_count.gte=500&language=en-US&page=1`));
      });

      // Fetch similar movies to their positive picks
      const positivePicks = [...Object.values(p1Picks), ...Object.values(p2Picks)]
        .filter(p => p.expr > 1)
        .slice(0, 4);
      positivePicks.forEach(p => {
        fetchPromises.push(fetchTMDB(`/movie/${p.movie.id}/similar?language=en-US&page=1`));
        fetchPromises.push(fetchTMDB(`/movie/${p.movie.id}/recommendations?language=en-US&page=1`));
      });

      const extras = await Promise.all(fetchPromises);
      extras.filter(Boolean).flatMap(d => d.results || []).forEach(m => {
        const norm = normalizeMovie(m);
        setCache(prev => ({...prev, [norm.id]: norm}));
      });
    } catch(e) {}

    await new Promise(r => setTimeout(r, 100));

    const getMovieProfile = (m) => {
      let int = 0, rom = 0, com = 0, cer = 0, count = 0;
      (m.genre_ids || []).forEach(gid => {
        const g = GENRES[gid];
        if (g) { int += g.intensity; rom += g.romance; com += g.comfort; cer += g.cerebral; count++; }
      });
      if (count === 0) return { intensity: 0.5, romance: 0.5, comfort: 0.5, cerebral: 0.5 };
      return { intensity: int/count, romance: rom/count, comfort: com/count, cerebral: cer/count };
    };

    const scored = Object.values(cache).map(movie => {
      let score = 0;
      const p1Pick = p1Picks[movie.id], p2Pick = p2Picks[movie.id];
      const movieProfile = getMovieProfile(movie);
      
      // Negative picks (0-2) reduce score
      if (p1Pick && p1Pick.expr <= 2) {
        score -= (3 - p1Pick.expr) * 10 * fairnessP1; // 0->30, 1->20, 2->10
      }
      if (p2Pick && p2Pick.expr <= 2) {
        score -= (3 - p2Pick.expr) * 10 * fairnessP2;
      }
      
      // HUGE bonus for mutual positive picks (expr >= 3) - the dream scenario
      if (p1Pick && p2Pick && p1Pick.expr >= 3 && p2Pick.expr >= 3) {
        const p1Strength = p1Pick.expr - 2; // 3->1, 4->2, 5->3, 6->4
        const p2Strength = p2Pick.expr - 2;
        const combined = (p1Strength * fairnessP1) + (p2Strength * fairnessP2);
        const agreementBonus = Math.min(p1Strength, p2Strength);
        score += combined * combined * 4;
        score += agreementBonus * agreementBonus * 8;
        // Extra bonus if both are really excited (5+)
        if (p1Pick.expr >= 5 && p2Pick.expr >= 5) {
          score += 50;
        }
      }
      
      // One person wants, other doesn't want - conflict but not a dealbreaker
      if (p1Pick && p2Pick) {
        if ((p1Pick.expr >= 4 && p2Pick.expr <= 1) || (p2Pick.expr >= 4 && p1Pick.expr <= 1)) {
          score -= 30; // It's a soft no, not a veto
        }
      }
      
      // Single positive pick still counts, but less than mutual
      if (p1Pick && p1Pick.expr >= 3 && !p2Pick) {
        const strength = p1Pick.expr - 2;
        score += strength * strength * 2 * fairnessP1;
      }
      if (p2Pick && p2Pick.expr >= 3 && !p1Pick) {
        const strength = p2Pick.expr - 2;
        score += strength * strength * 2 * fairnessP2;
      }

      // Genre matching - how well does this movie fit their combined taste?
      let genreMatchScore = 0;
      let genreCount = 0;
      (movie.genre_ids || []).forEach(gid => {
        const g = GENRES[gid];
        if (g) {
          genreCount++;
          // Bonus for genres they both like
          const genreWeight = center.genres[gid] || 0;
          genreMatchScore += genreWeight * 30;
          
          // Semantic fit - how close is this movie's vibe to what they want?
          genreMatchScore += (1 - Math.abs(g.intensity - center.intensity)) * 5;
          genreMatchScore += (1 - Math.abs(g.romance - center.romance)) * 5;
          genreMatchScore += (1 - Math.abs(g.comfort - center.comfort)) * 5;
          genreMatchScore += (1 - Math.abs(g.cerebral - center.cerebral)) * 5;
        }
      });
      if (genreCount > 0) {
        score += genreMatchScore / genreCount;
      }

      // Quality bonus - favor well-rated movies
      if (movie.rating >= 7) score += (movie.rating - 6) * 3;
      if (movie.rating >= 8) score += 5; // Extra bump for really good movies
      
      // Recency bonus - slight preference for newer movies
      const year = parseInt(movie.year);
      if (year >= 2023) score += 3;
      else if (year >= 2020) score += 1;

      // Discovery bonus - if movie fits their profile but wasn't picked, it's a discovery
      if (!p1Pick && !p2Pick) {
        // Calculate how well this movie fits both profiles
        const fitP1 = 1 - (Math.abs(movieProfile.intensity - prof1.intensity) + Math.abs(movieProfile.romance - prof1.romance) + Math.abs(movieProfile.comfort - prof1.comfort) + Math.abs(movieProfile.cerebral - prof1.cerebral)) / 4;
        const fitP2 = 1 - (Math.abs(movieProfile.intensity - prof2.intensity) + Math.abs(movieProfile.romance - prof2.romance) + Math.abs(movieProfile.comfort - prof2.comfort) + Math.abs(movieProfile.cerebral - prof2.cerebral)) / 4;
        
        // If it fits both well, it's a great discovery
        if (fitP1 > 0.7 && fitP2 > 0.7) {
          score += Math.min(fitP1, fitP2) * 20;
        }
      }

      // Penalize one-sided extreme positive picks (refusing compromise)
      if (p1Pick && p1Pick.expr > 0 && !p2Pick && lastPicker === 'p1') {
        const dist = Math.abs(movieProfile.intensity - prof2.intensity) + Math.abs(movieProfile.romance - prof2.romance) + Math.abs(movieProfile.comfort - prof2.comfort) + Math.abs(movieProfile.cerebral - prof2.cerebral);
        score -= dist * p1Pick.expr * 2.5;
        if (p1Pick.expr === 4) score -= 15;
      }
      if (p2Pick && p2Pick.expr > 0 && !p1Pick && lastPicker === 'p2') {
        const dist = Math.abs(movieProfile.intensity - prof1.intensity) + Math.abs(movieProfile.romance - prof1.romance) + Math.abs(movieProfile.comfort - prof1.comfort) + Math.abs(movieProfile.cerebral - prof1.cerebral);
        score -= dist * p2Pick.expr * 2.5;
        if (p2Pick.expr === 4) score -= 15;
      }

      return { movie, score };
    });

    scored.sort((a, b) => b.score - a.score);
    
    // Better match score calculation with more range
    const maxScore = scored[0]?.score || 1;
    const minScore = scored[4]?.score || 0;
    const top5 = scored.slice(0, 5).map((s, i) => {
      // Scale score to 65-98 range based on relative position
      let matchScore;
      if (i === 0) {
        matchScore = Math.min(98, Math.max(82, Math.round(75 + (s.score / Math.max(maxScore, 1)) * 23)));
      } else {
        const relativeScore = (s.score - minScore) / Math.max(maxScore - minScore, 1);
        matchScore = Math.min(92, Math.max(65, Math.round(65 + relativeScore * 27)));
      }
      // Check if this movie was picked by either person
      const isDiscovery = !p1Picks[s.movie.id] && !p2Picks[s.movie.id];
      return {...s, matchScore, isDiscovery};
    });

    setTimeout(() => { setResult(top5); setPhase('result'); }, 5000);
  };

  const shareResult = () => {
    const text = `üé¨ We used MovieNight to settle our movie debate!\n\nThe verdict: "${result[0].movie.title}" (${result[0].matchScore}% match)\n\nTired of fighting about what to watch? Try it:`;
    const url = window.location.origin + window.location.pathname;
    if (navigator.share) {
      navigator.share({ title: 'MovieNight - Stop Fighting About What to Watch', text, url });
    } else {
      navigator.clipboard.writeText(text + ' ' + url);
      alert('Copied to clipboard!');
    }
  };

  const reset = () => {
    setPhase('q1'); setP1Picks({}); setP2Picks({}); setLastPicker(null);
    setLastMovieRatingP1(null); setLastMovieRatingP2(null); setLastMovie(null); setResult(null);
  };

  return (
    <div style={{minHeight:'100vh',padding:'16px',maxWidth:'1100px',margin:'0 auto'}}>
      <header style={{textAlign:'center',padding:'20px 16px 16px',position:'relative'}}>
        {/* Top bar with buttons */}
        <div style={{display:'flex',justifyContent:'center',gap:'8px',marginBottom:'12px',flexWrap:'wrap'}}>
          <button onClick={() => setShowHowItWorks(true)} style={{
            padding:'6px 12px',borderRadius:'14px',border:'1px solid var(--elevated)',
            background:'rgba(24,24,31,0.8)',color:'var(--muted)',fontSize:'11px',fontWeight:'600',cursor:'pointer'
          }}>How it works</button>
          {!user ? (
            <>
              <button onClick={() => setShowSignUp(true)} style={{
                padding:'6px 12px',borderRadius:'14px',border:'1px solid var(--elevated)',
                background:'rgba(24,24,31,0.8)',color:'var(--muted)',fontSize:'11px',fontWeight:'600',cursor:'pointer'
              }}>Sign Up</button>
              <button onClick={() => setShowLogin(true)} style={{
                padding:'6px 12px',borderRadius:'14px',border:'1px solid var(--elevated)',
                background:'rgba(24,24,31,0.8)',color:'var(--muted)',fontSize:'11px',fontWeight:'600',cursor:'pointer'
              }}>Log In</button>
            </>
          ) : (
            <span style={{padding:'6px 12px',fontSize:'11px',color:'var(--gold)'}}>üëã {user.email.split('@')[0]}</span>
          )}
        </div>
        
        <h1 onClick={reset} className="space" style={{fontSize:'clamp(28px,7vw,48px)',fontWeight:'700',marginBottom:'6px',background:'linear-gradient(135deg,var(--p1),var(--gold),var(--p2))',WebkitBackgroundClip:'text',WebkitTextFillColor:'transparent',cursor:'pointer'}}>
          MovieNight
        </h1>
        <p style={{fontSize:'13px',color:'var(--muted)',marginBottom:'4px'}}>Find the movies you'll love together ‚Äî by compromise or by judgment.</p>
        {phase === 'q1' && (
          <div style={{marginTop:'8px'}}>
            <p style={{fontSize:'11px',color:'var(--dim)',letterSpacing:'1.5px',fontWeight:'500',textTransform:'uppercase'}}>
              THOU SHALL SHARE THE REMOTE
            </p>
            <p style={{fontSize:'10px',color:'var(--dim)',marginTop:'2px',fontStyle:'italic'}}>An ancient law. Recently enforced.</p>
          </div>
        )}
      </header>

      {/* How it Works Modal */}
      {showHowItWorks && (
        <div style={{
          position:'fixed',inset:0,background:'rgba(0,0,0,0.8)',backdropFilter:'blur(8px)',
          display:'flex',alignItems:'center',justifyContent:'center',zIndex:1000,padding:'20px',
          animation:'fadeIn 0.3s ease-out'
        }} onClick={() => setShowHowItWorks(false)}>
          <div style={{
            background:'var(--card)',borderRadius:'24px',padding:'32px',maxWidth:'480px',width:'100%',
            border:'1px solid var(--elevated)',boxShadow:'0 25px 80px rgba(0,0,0,0.5)',
            animation:'reveal 0.3s ease-out'
          }} onClick={(e) => e.stopPropagation()}>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'24px'}}>
              <h2 className="space" style={{fontSize:'22px',fontWeight:'700'}}>How MovieNight Works</h2>
              <button onClick={() => setShowHowItWorks(false)} style={{
                width:'32px',height:'32px',borderRadius:'50%',border:'none',background:'var(--elevated)',
                color:'var(--muted)',fontSize:'18px',cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center'
              }}>√ó</button>
            </div>
            
            <div style={{display:'flex',flexDirection:'column',gap:'20px'}}>
              <div style={{display:'flex',gap:'14px',alignItems:'flex-start'}}>
                <div style={{width:'36px',height:'36px',borderRadius:'12px',background:'var(--p1-soft)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:'18px',flexShrink:0}}>üìã</div>
                <div>
                  <h3 style={{fontSize:'15px',fontWeight:'600',marginBottom:'4px'}}>1. Answer a few questions</h3>
                  <p style={{fontSize:'13px',color:'var(--muted)',lineHeight:'1.5'}}>Tell us who picked last time and how it went. This helps us keep things fair.</p>
                </div>
              </div>
              
              <div style={{display:'flex',gap:'14px',alignItems:'flex-start'}}>
                <div style={{width:'36px',height:'36px',borderRadius:'12px',background:'var(--p2-soft)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:'18px',flexShrink:0}}>üé¨</div>
                <div>
                  <h3 style={{fontSize:'15px',fontWeight:'600',marginBottom:'4px'}}>2. Each pick 2-3 movies</h3>
                  <p style={{fontSize:'13px',color:'var(--muted)',lineHeight:'1.5'}}>Search for movies you'd want to watch tonight. Rate how much you want each one ‚Äî slide left if you're less interested.</p>
                </div>
              </div>
              
              <div style={{display:'flex',gap:'14px',alignItems:'flex-start'}}>
                <div style={{width:'36px',height:'36px',borderRadius:'12px',background:'var(--gold-soft)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:'18px',flexShrink:0}}>‚öñÔ∏è</div>
                <div>
                  <h3 style={{fontSize:'15px',fontWeight:'600',marginBottom:'4px'}}>3. Get your verdict</h3>
                  <p style={{fontSize:'13px',color:'var(--muted)',lineHeight:'1.5'}}>Our algorithm finds the movie you'll both enjoy. Agreement is rewarded. Stubbornness... isn't.</p>
                </div>
              </div>
            </div>
            
            <div style={{marginTop:'24px',padding:'16px',background:'var(--elevated)',borderRadius:'14px',textAlign:'center'}}>
              <p style={{fontSize:'12px',color:'var(--dim)',marginBottom:'4px'}}>‚öñÔ∏è A Word of Caution</p>
              <p style={{fontSize:'13px',color:'var(--muted)',fontStyle:'italic'}}>Those who find agreement may be favored. Those who refuse all compromise may be judged.</p>
            </div>
            
            <button onClick={() => setShowHowItWorks(false)} style={{
              width:'100%',marginTop:'24px',padding:'14px',borderRadius:'14px',border:'none',
              background:'var(--gold)',color:'var(--bg)',fontSize:'15px',fontWeight:'700',cursor:'pointer'
            }}>Got it</button>
          </div>
        </div>
      )}

      {/* Sign Up Modal - Waitlist */}
      {showSignUp && (
        <div style={{
          position:'fixed',inset:0,background:'rgba(0,0,0,0.8)',backdropFilter:'blur(8px)',
          display:'flex',alignItems:'center',justifyContent:'center',zIndex:1000,padding:'20px',
          animation:'fadeIn 0.3s ease-out'
        }} onClick={() => {setShowSignUp(false);setAuthError('');setAuthSuccess('');}}>
          <div style={{
            background:'var(--card)',borderRadius:'24px',padding:'32px',maxWidth:'440px',width:'100%',
            border:'1px solid var(--elevated)',boxShadow:'0 25px 80px rgba(0,0,0,0.5)',
            animation:'reveal 0.3s ease-out',maxHeight:'90vh',overflowY:'auto'
          }} onClick={(e) => e.stopPropagation()}>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'20px'}}>
              <h2 className="space" style={{fontSize:'22px',fontWeight:'700'}}>Join the Waitlist ‚ú®</h2>
              <button onClick={() => {setShowSignUp(false);setAuthError('');setAuthSuccess('');}} style={{
                width:'32px',height:'32px',borderRadius:'50%',border:'none',background:'var(--elevated)',
                color:'var(--muted)',fontSize:'18px',cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center'
              }}>√ó</button>
            </div>
            
            <div style={{background:'linear-gradient(135deg, rgba(168,85,247,0.1), rgba(255,107,107,0.1))',borderRadius:'14px',padding:'16px',marginBottom:'20px'}}>
              <p style={{fontSize:'14px',color:'var(--muted)',lineHeight:'1.6',textAlign:'center'}}>
                üé¨ We're brand new and still getting things set up, but let us know you're interested and we'll let you know when we're ready for you!
              </p>
            </div>
            
            <div style={{display:'flex',flexDirection:'column',gap:'14px',marginBottom:'16px'}}>
              <div>
                <label style={{fontSize:'12px',color:'var(--muted)',marginBottom:'6px',display:'block'}}>Your Email</label>
                <input 
                  type="email" 
                  placeholder="movie.lover@email.com" 
                  value={authEmail}
                  onChange={(e) => setAuthEmail(e.target.value)}
                  style={{
                    padding:'14px 16px',borderRadius:'12px',border:'2px solid var(--elevated)',
                    background:'var(--bg)',color:'var(--text)',fontSize:'14px',width:'100%'
                  }}
                />
              </div>
              
              <div>
                <label style={{fontSize:'12px',color:'var(--muted)',marginBottom:'6px',display:'block'}}>üçø Quick question: What's the last movie you and your partner couldn't agree on?</label>
                <input 
                  type="text" 
                  placeholder="e.g., They wanted horror, I wanted comedy..." 
                  value={waitlistQuestion}
                  onChange={(e) => setWaitlistQuestion(e.target.value)}
                  style={{
                    padding:'14px 16px',borderRadius:'12px',border:'2px solid var(--elevated)',
                    background:'var(--bg)',color:'var(--text)',fontSize:'14px',width:'100%'
                  }}
                />
              </div>
              
              <div>
                <label style={{fontSize:'12px',color:'var(--muted)',marginBottom:'6px',display:'block'}}>Anything else you want to tell us? (optional)</label>
                <textarea 
                  placeholder="Feedback, feature requests, or just say hi!" 
                  value={waitlistMessage}
                  onChange={(e) => setWaitlistMessage(e.target.value)}
                  rows={3}
                  style={{
                    padding:'14px 16px',borderRadius:'12px',border:'2px solid var(--elevated)',
                    background:'var(--bg)',color:'var(--text)',fontSize:'14px',width:'100%',resize:'vertical',fontFamily:'inherit'
                  }}
                />
              </div>
            </div>
            
            {authError && <p style={{color:'var(--p1)',fontSize:'12px',marginBottom:'12px'}}>{authError}</p>}
            {authSuccess && <p style={{color:'var(--p2)',fontSize:'13px',marginBottom:'12px',textAlign:'center'}}>{authSuccess}</p>}
            
            {!authSuccess && (
              <button onClick={async () => {
                if (!authEmail) {
                  setAuthError('Please enter your email');
                  return;
                }
                if (!authEmail.includes('@')) {
                  setAuthError('Please enter a valid email');
                  return;
                }
                
                setAuthError('');
                
                try {
                  // Use FormSubmit.co - free email API (no signup required)
                  const response = await fetch('https://formsubmit.co/ajax/themovienightjudge@gmail.com', {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                      'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                      _subject: 'MovieNight Waitlist Signup! üé¨',
                      email: authEmail,
                      movie_disagreement: waitlistQuestion || 'Not provided',
                      message: waitlistMessage || 'None',
                      signed_up: new Date().toLocaleString()
                    })
                  });
                  
                  if (response.ok) {
                    setAuthSuccess("üéâ You're on the list! We'll email you when we're ready.");
                    // Also store locally as backup
                    const waitlist = JSON.parse(localStorage.getItem('movienight_waitlist') || '[]');
                    waitlist.push({ email: authEmail, question: waitlistQuestion, message: waitlistMessage, date: Date.now() });
                    localStorage.setItem('movienight_waitlist', JSON.stringify(waitlist));
                  } else {
                    setAuthError('Something went wrong. Please try again.');
                  }
                } catch (err) {
                  // Fallback: store locally and show success anyway
                  const waitlist = JSON.parse(localStorage.getItem('movienight_waitlist') || '[]');
                  waitlist.push({ email: authEmail, question: waitlistQuestion, message: waitlistMessage, date: Date.now() });
                  localStorage.setItem('movienight_waitlist', JSON.stringify(waitlist));
                  setAuthSuccess("üéâ You're on the list! We'll email you when we're ready.");
                }
                
              }} style={{
                width:'100%',padding:'16px',borderRadius:'14px',border:'none',
                background:'linear-gradient(135deg,var(--purple),var(--p1))',color:'white',
                fontSize:'15px',fontWeight:'700',cursor:'pointer'
              }}>Join the Waitlist üé¨</button>
            )}
            
            {authSuccess && (
              <button onClick={() => {
                setShowSignUp(false);
                setAuthEmail('');
                setWaitlistQuestion('');
                setWaitlistMessage('');
                setAuthError('');
                setAuthSuccess('');
              }} style={{
                width:'100%',padding:'16px',borderRadius:'14px',border:'none',
                background:'var(--gold)',color:'var(--bg)',
                fontSize:'15px',fontWeight:'700',cursor:'pointer'
              }}>Done!</button>
            )}
            
            <p style={{fontSize:'10px',color:'var(--dim)',textAlign:'center',marginTop:'16px'}}>
              Questions? Email themovienightjudge@gmail.com
            </p>
          </div>
        </div>
      )}

      {/* Login Modal - Coming Soon */}
      {showLogin && (
        <div style={{
          position:'fixed',inset:0,background:'rgba(0,0,0,0.8)',backdropFilter:'blur(8px)',
          display:'flex',alignItems:'center',justifyContent:'center',zIndex:1000,padding:'20px',
          animation:'fadeIn 0.3s ease-out'
        }} onClick={() => setShowLogin(false)}>
          <div style={{
            background:'var(--card)',borderRadius:'24px',padding:'32px',maxWidth:'400px',width:'100%',
            border:'1px solid var(--elevated)',boxShadow:'0 25px 80px rgba(0,0,0,0.5)',
            animation:'reveal 0.3s ease-out',textAlign:'center'
          }} onClick={(e) => e.stopPropagation()}>
            <div style={{fontSize:'48px',marginBottom:'16px'}}>üîê</div>
            <h2 className="space" style={{fontSize:'22px',fontWeight:'700',marginBottom:'12px'}}>Coming Soon</h2>
            <p style={{fontSize:'14px',color:'var(--muted)',marginBottom:'24px',lineHeight:'1.6'}}>
              Login functionality is coming soon! For now, join our waitlist to be first in line when we launch.
            </p>
            <div style={{display:'flex',gap:'12px',justifyContent:'center'}}>
              <button onClick={() => {setShowLogin(false);setShowSignUp(true);}} style={{
                padding:'14px 24px',borderRadius:'14px',border:'none',
                background:'linear-gradient(135deg,var(--purple),var(--p1))',color:'white',
                fontSize:'15px',fontWeight:'700',cursor:'pointer'
              }}>Join Waitlist</button>
              <button onClick={() => setShowLogin(false)} style={{
                padding:'14px 24px',borderRadius:'14px',border:'2px solid var(--elevated)',
                background:'transparent',color:'var(--muted)',
                fontSize:'15px',fontWeight:'600',cursor:'pointer'
              }}>Close</button>
            </div>
          </div>
        </div>
      )}

      {/* Mobile Handoff Screen */}
      {showHandoff && (
        <div style={{
          position:'fixed',inset:0,background:'var(--bg)',
          display:'flex',alignItems:'center',justifyContent:'center',zIndex:1000,padding:'20px',
          animation:'fadeIn 0.3s ease-out'
        }}>
          <div style={{textAlign:'center',maxWidth:'320px'}}>
            <div style={{fontSize:'64px',marginBottom:'20px',animation:'pulse 1.5s ease-in-out infinite'}}>
              {currentTurn === 2 ? 'üòà' : 'üòá'}
            </div>
            <h2 className="space" style={{fontSize:'24px',fontWeight:'700',marginBottom:'12px',color: currentTurn === 2 ? 'var(--p1)' : 'var(--p2)'}}>
              {currentTurn === 2 ? "Partner 2's Turn" : "Partner 1's Turn"}
            </h2>
            <p style={{fontSize:'14px',color:'var(--muted)',marginBottom:'24px',lineHeight:'1.5'}}>
              {currentTurn === 2 
                ? "Hand the phone to your partner. It's their turn to pick movies!" 
                : "You're up first! Pick 2-3 movies you'd want to watch tonight."}
            </p>
            <button onClick={() => setShowHandoff(false)} style={{
              padding:'16px 48px',borderRadius:'50px',border:'none',
              background: currentTurn === 2 ? 'var(--p1)' : 'var(--p2)',
              color:'white',fontSize:'16px',fontWeight:'700',cursor:'pointer'
            }}>
              {currentTurn === 2 ? "I'm Partner 2 ‚Äî Let's Go" : "I'm Ready"}
            </button>
          </div>
        </div>
      )}

      {phase === 'q1' && (
        <div style={{maxWidth:'500px',margin:'20px auto',padding:'0 16px',animation:'fadeIn 0.4s ease-out'}}>
          <div style={{background:'var(--card)',borderRadius:'24px',padding:'36px 28px',textAlign:'center'}}>
            <div style={{fontSize:'48px',marginBottom:'16px'}}>‚öñÔ∏è</div>
            <p style={{fontSize:'12px',color:'var(--dim)',marginBottom:'8px',textTransform:'uppercase',letterSpacing:'2px'}}>Step 1 of 3 ‚Äî Accountability</p>
            <h2 className="space" style={{fontSize:'24px',fontWeight:'700',marginBottom:'8px'}}>Be honest.</h2>
            <h2 className="space" style={{fontSize:'24px',fontWeight:'700',marginBottom:'24px'}}>Who picked last time?</h2>
            <p style={{fontSize:'13px',color:'var(--dim)',marginBottom:'24px',fontStyle:'italic'}}>We'll know if you lie. üîÆ</p>
            <div style={{display:'flex',flexDirection:'column',gap:'12px',marginBottom:'28px'}}>
              <button className={`btn-choice ${lastPicker === 'p1' ? 'active' : ''}`} onClick={() => setLastPicker('p1')}
                style={lastPicker === 'p1' ? {borderColor:'var(--p2)',background:'var(--p2-soft)',color:'var(--p2)'} : {}}>
                <span style={{fontSize:'24px'}}>üòá</span> I did
              </button>
              <button className={`btn-choice ${lastPicker === 'p2' ? 'active' : ''}`} onClick={() => setLastPicker('p2')}
                style={lastPicker === 'p2' ? {borderColor:'var(--p1)',background:'var(--p1-soft)',color:'var(--p1)'} : {}}>
                <span style={{fontSize:'24px'}}>üòà</span> They did
              </button>
              <button className={`btn-choice ${lastPicker === 'mutual' ? 'active' : ''}`} onClick={() => setLastPicker('mutual')}>
                <span style={{fontSize:'24px'}}>‚ú®</span> We actually agreed (miracle)
              </button>
            </div>
            <div style={{display:'flex',gap:'12px'}}>
              <button onClick={() => { setLastPicker('mutual'); setPhase('picking'); }} style={{flex:1,padding:'16px',borderRadius:'14px',border:'2px solid var(--elevated)',background:'transparent',color:'var(--dim)',fontSize:'14px',fontWeight:'600',cursor:'pointer'}}>Avoid responsibility</button>
              <button onClick={() => setPhase('q2')} disabled={!lastPicker} style={{flex:2,padding:'16px',borderRadius:'14px',border:'none',background: lastPicker ? 'var(--gold)' : 'var(--elevated)',color: lastPicker ? 'var(--bg)' : 'var(--dim)',fontSize:'15px',fontWeight:'700',cursor: lastPicker ? 'pointer' : 'not-allowed'}}>Continue the trial ‚Üí</button>
            </div>
          </div>
        </div>
      )}

      {phase === 'q2' && (
        <div style={{maxWidth:'500px',margin:'20px auto',padding:'0 16px',animation:'fadeIn 0.4s ease-out'}}>
          <div style={{background:'var(--card)',borderRadius:'24px',padding:'36px 28px'}}>
            <div style={{textAlign:'center',marginBottom:'28px'}}>
              <div style={{fontSize:'48px',marginBottom:'16px'}}>üçø</div>
              <p style={{fontSize:'12px',color:'var(--dim)',marginBottom:'8px',textTransform:'uppercase',letterSpacing:'2px'}}>Step 2 of 3 ‚Äî Evidence</p>
              <h2 className="space" style={{fontSize:'24px',fontWeight:'700'}}>How did that go?</h2>
            </div>
            <div style={{marginBottom:'28px'}}>
              <p style={{fontSize:'15px',fontWeight:'600',marginBottom:'14px',textAlign:'center'}}>üòá How much did <span style={{color:'var(--p2)'}}>you</span> like it?</p>
              <RatingButtons value={lastMovieRatingP1} onChange={setLastMovieRatingP1} color="var(--p2)" />
            </div>
            <div style={{marginBottom:'28px'}}>
              <p style={{fontSize:'15px',fontWeight:'600',marginBottom:'14px',textAlign:'center'}}>üòà How much did <span style={{color:'var(--p1)'}}>they</span> like it?</p>
              <RatingButtons value={lastMovieRatingP2} onChange={setLastMovieRatingP2} color="var(--p1)" />
            </div>
            <div style={{display:'flex',gap:'12px'}}>
              <button onClick={() => setPhase('q1')} style={{flex:1,padding:'16px',borderRadius:'14px',border:'2px solid var(--elevated)',background:'transparent',color:'var(--muted)',fontSize:'14px',fontWeight:'600',cursor:'pointer'}}>‚Üê Back</button>
              <button onClick={() => setPhase('q3')} disabled={!lastMovieRatingP1 || !lastMovieRatingP2} style={{flex:2,padding:'16px',borderRadius:'14px',border:'none',background: (lastMovieRatingP1 && lastMovieRatingP2) ? 'var(--gold)' : 'var(--elevated)',color: (lastMovieRatingP1 && lastMovieRatingP2) ? 'var(--bg)' : 'var(--dim)',fontSize:'15px',fontWeight:'700',cursor: (lastMovieRatingP1 && lastMovieRatingP2) ? 'pointer' : 'not-allowed'}}>Continue ‚Üí</button>
            </div>
          </div>
        </div>
      )}

      {phase === 'q3' && (
        <div style={{maxWidth:'500px',margin:'20px auto',padding:'0 16px',animation:'fadeIn 0.4s ease-out'}}>
          <div style={{background:'var(--card)',borderRadius:'24px',padding:'36px 28px'}}>
            <div style={{textAlign:'center',marginBottom:'24px'}}>
              <div style={{fontSize:'48px',marginBottom:'16px'}}>üé•</div>
              <p style={{fontSize:'12px',color:'var(--dim)',marginBottom:'8px',textTransform:'uppercase',letterSpacing:'2px'}}>Step 3 of 3 ‚Äî The Record</p>
              <h2 className="space" style={{fontSize:'24px',fontWeight:'700'}}>What was the movie?</h2>
              <p style={{fontSize:'13px',color:'var(--dim)',marginTop:'8px'}}>Optional ‚Äî but we're keeping track üìù</p>
            </div>
            <div style={{marginBottom:'24px'}}>
              <LastMovieSearch value={lastMovie} onChange={setLastMovie} movies={movies} onSearch={search} />
            </div>
            <div style={{display:'flex',gap:'12px'}}>
              <button onClick={() => setPhase('q2')} style={{flex:1,padding:'16px',borderRadius:'14px',border:'2px solid var(--elevated)',background:'transparent',color:'var(--muted)',fontSize:'14px',fontWeight:'600',cursor:'pointer'}}>‚Üê Back</button>
              <button onClick={() => setPhase('picking')} style={{flex:2,padding:'16px',borderRadius:'14px',border:'none',background:'var(--gold)',color:'var(--bg)',fontSize:'15px',fontWeight:'700',cursor:'pointer'}}>{lastMovie ? 'Start picking ‚Üí' : 'Skip & start ‚Üí'}</button>
            </div>
          </div>
        </div>
      )}

      {phase === 'picking' && (
        <>
          {/* Mobile Turn-Based Picking */}
          {isMobile ? (
            <div style={{
              padding:'0 16px'
            }}>
              {/* Compact header with turn indicator and progress */}
              <div style={{
                display:'flex',alignItems:'center',justifyContent:'space-between',
                marginBottom:'12px',padding:'10px 14px',
                background:'var(--card)',borderRadius:'50px'
              }}>
                <div style={{display:'flex',alignItems:'center',gap:'6px'}}>
                  <span style={{fontSize:'18px'}}>{currentTurn === 1 ? 'üòá' : 'üòà'}</span>
                  <span style={{fontSize:'13px',fontWeight:'700',color:'var(--text)'}}>
                    {currentTurn === 1 ? "Your turn" : "Their turn"}
                  </span>
                  <span style={{fontSize:'12px',color:'var(--muted)'}}>
                    ‚Ä¢ {currentTurn === 1 ? Object.keys(p1Picks).length : Object.keys(p2Picks).length}/4
                  </span>
                </div>
                {/* Progress dots */}
                <div style={{display:'flex',gap:'4px'}}>
                  {[0,1,2,3].map(i => {
                    const picks = currentTurn === 1 ? Object.values(p1Picks) : Object.values(p2Picks);
                    const pick = picks[i];
                    let dotColor = 'var(--elevated)';
                    if (pick) {
                      if (pick.expr >= 5) dotColor = 'var(--gold)';
                      else if (pick.expr >= 3) dotColor = '#4ADE80';
                      else dotColor = 'var(--p1)';
                    }
                    return (
                      <div key={i} style={{
                        width:'18px',height:'6px',borderRadius:'3px',
                        background: dotColor,
                        transition:'background 0.3s'
                      }}/>
                    );
                  })}
                </div>
              </div>
              
              {/* Condensed instruction - only show if no picks yet */}
              {(currentTurn === 1 ? Object.keys(p1Picks).length : Object.keys(p2Picks).length) === 0 && (
                <div style={{textAlign:'center',marginBottom:'12px'}}>
                  <p style={{fontSize:'13px',color:'var(--text)',marginBottom:'4px'}}>
                    Pick the movies you'd like to watch tonight
                  </p>
                  <p style={{fontSize:'11px',color:'var(--muted)'}}>
                    Slide right for <span style={{color:'#4ADE80'}}>yes</span>, left for <span style={{color:'var(--p1)'}}>no</span>
                  </p>
                </div>
              )}
              
              {/* Scrollable picks area - max height, scrolls when content overflows */}
              <div style={{
                maxHeight:'calc(100vh - 340px)',
                overflowY:'auto',
                WebkitOverflowScrolling:'touch',
                marginBottom:'16px',
                border:'2px solid var(--elevated)',
                borderRadius:'20px',
                padding:'12px'
              }}>
                <MobileTurnColumn 
                  turn={currentTurn}
                  picks={currentTurn === 1 ? Object.values(p1Picks) : Object.values(p2Picks)}
                  onAddPick={(m) => addPick(m, currentTurn)}
                  onRemovePick={(id) => removePick(id, currentTurn)}
                  onExpressionChange={(id, val) => setExpr(id, val, currentTurn)}
                  movies={movies}
                  onSearch={search}
                  loading={loading}
                  allPicks={{p1: p1Picks, p2: p2Picks}}
                  mobileSearchOpen={mobileSearchOpen}
                  setMobileSearchOpen={setMobileSearchOpen}
                />
              </div>
              
              {/* Bottom section - always visible */}
              <div style={{paddingBottom:'20px'}}>
                {/* Sentiment Tag */}
                {(() => {
                  const picks = currentTurn === 1 ? Object.values(p1Picks) : Object.values(p2Picks);
                  const sentimentTag = getSentimentTag(picks);
                  return sentimentTag ? (
                    <div style={{display:'flex',justifyContent:'center',marginBottom:'10px'}}>
                      <div style={{
                        display:'inline-flex',alignItems:'center',gap:'8px',
                        padding:'6px 12px',borderRadius:'20px',
                        background:'var(--card)'
                      }}>
                        <span>{sentimentTag.emoji}</span>
                        <span style={{fontSize:'12px',color:sentimentTag.color,fontWeight:'600'}}>{sentimentTag.text}</span>
                      </div>
                    </div>
                  ) : null;
                })()}
                
                {/* Quote */}
                <p style={{fontSize:'10px',color:'var(--dim)',textAlign:'center',marginBottom:'10px',fontStyle:'italic'}}>
                  "Agreement is rewarded. Stubbornness is judged."
                </p>
                
                {/* Done button */}
                {currentTurn === 1 ? (
                  <button 
                    onClick={() => {setCurrentTurn(2);setShowHandoff(true);}} 
                    disabled={Object.keys(p1Picks).length < 1}
                    style={{
                      padding:'16px',borderRadius:'50px',border:'none',
                      background: Object.keys(p1Picks).length >= 1 
                        ? 'linear-gradient(135deg, #E8F5E9, #C8E6C9)' 
                        : '#2a2a35',
                      color: Object.keys(p1Picks).length >= 1 ? '#2E7D32' : '#666',
                      fontSize:'15px',fontWeight:'700',
                      cursor: Object.keys(p1Picks).length >= 1 ? 'pointer' : 'not-allowed',
                      width:'100%',
                      display:'flex',alignItems:'center',justifyContent:'center',gap:'8px'
                    }}
                  >
                    {Object.keys(p1Picks).length >= 1 ? <>‚úì Done</> : <>Add a movie to continue</>}
                  </button>
                ) : (
                  <button 
                    onClick={findMatch} 
                    disabled={Object.keys(p2Picks).length < 1}
                    style={{
                      padding:'16px',borderRadius:'50px',border:'none',
                      background: Object.keys(p2Picks).length >= 1 
                        ? 'linear-gradient(135deg,#FF6B6B,#FFD93D,#4ECDC4)' 
                        : '#2a2a35',
                      color: Object.keys(p2Picks).length >= 1 ? 'white' : '#666',
                      fontSize:'15px',fontWeight:'700',
                      cursor: Object.keys(p2Picks).length >= 1 ? 'pointer' : 'not-allowed',
                      width:'100%'
                    }}
                  >
                    {Object.keys(p2Picks).length >= 1 ? <>‚úì Done</> : <>Add a movie to continue</>}
                  </button>
                )}
                
                {/* No peeking message */}
                <p style={{fontSize:'10px',color:'var(--muted)',textAlign:'center',marginTop:'10px'}}>
                  üëÄ Tell your partner not to peek ‚Äî don't show your picks!
                </p>
                
                {/* Copyright */}
                <p style={{fontSize:'9px',color:'var(--dim)',textAlign:'center',marginTop:'10px'}}>
                  ¬© 2026 Tyler Friddle. All Rights Reserved.
                </p>
              </div>
            </div>
          ) : (
            /* Desktop side-by-side picking */
            <>
              <p style={{textAlign:'center',fontSize:'15px',color:'var(--muted)',marginBottom:'16px'}}>Pick 1-4 movies each. Rate how much you want to watch them tonight.</p>
              
              {/* Caution Message */}
              <div style={{maxWidth:'600px',margin:'0 auto 28px',padding:'0 16px'}}>
                <div style={{
                  background:'linear-gradient(135deg, rgba(255,217,61,0.06), rgba(168,85,247,0.06))',
                  borderRadius:'16px',padding:'20px',textAlign:'center',
                  border:'1px solid rgba(255,217,61,0.15)'
                }}>
                  <p style={{fontSize:'13px',color:'var(--gold)',marginBottom:'6px',fontWeight:'600'}}>‚öñÔ∏è A Word of Caution</p>
                  <p style={{fontSize:'13px',color:'var(--muted)',lineHeight:'1.6'}}>
                    Those who find agreement may be favored.<br/>
                    Those who refuse all compromise may be judged.
                  </p>
                  <p style={{fontSize:'12px',color:'var(--dim)',marginTop:'10px',lineHeight:'1.5'}}>
                    üí° <span style={{color:'var(--muted)'}}>Tip:</span> Slide left to show less interest, right for more. The algorithm sees all.
                  </p>
                </div>
              </div>
              
              <div className="partner-columns" style={{display:'flex',gap:'24px',flexWrap:'wrap',marginBottom:'28px'}}>
                <PartnerColumn name="You" emoji="üòá" color="var(--p2)" picks={Object.values(p1Picks)}
                  onAddPick={(m) => addPick(m, 1)} onRemovePick={(id) => removePick(id, 1)}
                  onExpressionChange={(id, val) => setExpr(id, val, 1)} allPicks={{p1: p1Picks, p2: p2Picks}}
                  movies={movies} onSearch={search} loading={loading} player={1} />
                <div className="vs-circle" style={{display:'flex',alignItems:'center',justifyContent:'center',padding:'20px 0'}}>
                  <div style={{width:'56px',height:'56px',borderRadius:'50%',background:'var(--elevated)',border:'3px solid var(--gold)',display:'flex',alignItems:'center',justifyContent:'center',fontWeight:'700',fontSize:'16px',color:'var(--gold)',boxShadow:'0 4px 20px rgba(255,217,61,0.3)'}}>VS</div>
                </div>
                <PartnerColumn name="Them" emoji="üòà" color="var(--p1)" picks={Object.values(p2Picks)}
                  onAddPick={(m) => addPick(m, 2)} onRemovePick={(id) => removePick(id, 2)}
                  onExpressionChange={(id, val) => setExpr(id, val, 2)} allPicks={{p1: p1Picks, p2: p2Picks}}
                  movies={movies} onSearch={search} loading={loading} player={2} />
              </div>
              <div style={{textAlign:'center'}}>
                <button onClick={findMatch} disabled={!canFindMatch} style={{
                  padding:'18px 48px',borderRadius:'50px',border:'none',fontSize:'17px',fontWeight:'700',
                  cursor: canFindMatch ? 'pointer' : 'not-allowed',
                  background: canFindMatch ? 'linear-gradient(135deg,var(--p1),var(--gold),var(--p2))' : 'var(--elevated)',
                  color: canFindMatch ? 'white' : 'var(--dim)',
                  boxShadow: canFindMatch ? '0 10px 40px rgba(255,217,61,0.4)' : 'none',
                  animation: canFindMatch ? 'glow 2s ease-in-out infinite' : 'none'
                }}>{canFindMatch ? '‚öñÔ∏è Deliver the Verdict' : `Need ${Math.max(0, 1 - p1Count) + Math.max(0, 1 - p2Count)} more picks`}</button>
              </div>
            </>
          )}
        </>
      )}

      {phase === 'calculating' && (
        <div style={{textAlign:'center',padding:'60px 20px'}}>
          {/* Animated scales */}
          <div style={{position:'relative',width:'140px',height:'140px',margin:'0 auto 32px'}}>
            {/* Outer glow ring */}
            <div style={{
              position:'absolute',inset:'-20px',borderRadius:'50%',
              background:'radial-gradient(circle, rgba(255,217,61,0.2) 0%, transparent 70%)',
              animation:'pulse 2s ease-in-out infinite'
            }}/>
            {/* Spinning gradient */}
            <div style={{
              position:'absolute',inset:0,borderRadius:'50%',
              background:'conic-gradient(var(--p1),var(--gold),var(--p2),var(--purple),var(--p1))',
              animation:'spin 3s linear infinite'
            }}/>
            {/* Inner spinning (opposite) */}
            <div style={{
              position:'absolute',inset:'8px',borderRadius:'50%',
              background:'conic-gradient(var(--p2),var(--purple),var(--gold),var(--p1),var(--p2))',
              animation:'spin 2s linear infinite reverse'
            }}/>
            {/* Center icon */}
            <div style={{
              position:'absolute',inset:'20px',borderRadius:'50%',background:'var(--bg)',
              display:'flex',alignItems:'center',justifyContent:'center',fontSize:'48px',
              animation:'pulse 1.5s ease-in-out infinite'
            }}>‚öñÔ∏è</div>
            {/* Orbiting particles */}
            {[0,1,2,3].map(i => (
              <div key={i} style={{
                position:'absolute',width:'8px',height:'8px',borderRadius:'50%',
                background: i % 2 === 0 ? 'var(--gold)' : 'var(--purple)',
                top:'50%',left:'50%',
                transform:`rotate(${i * 90}deg) translateX(80px)`,
                animation:`spin ${4 + i}s linear infinite`,
                boxShadow: `0 0 10px ${i % 2 === 0 ? 'var(--gold)' : 'var(--purple)'}`
              }}/>
            ))}
          </div>
          
          <h2 className="space" style={{fontSize:'28px',marginBottom:'16px',background:'linear-gradient(135deg,var(--p1),var(--gold),var(--p2))',WebkitBackgroundClip:'text',WebkitTextFillColor:'transparent'}}>
            Deliberating...
          </h2>
          
          {/* Animated status messages */}
          <div style={{minHeight:'80px'}}>
            <DeliberationMessages />
          </div>
        </div>
      )}

      {phase === 'result' && result && (
        <div style={{animation:'reveal 0.5s ease-out'}}>
          {/* Share button at TOP for mobile - viral priority */}
          <div style={{textAlign:'center',marginBottom:'20px',padding:'0 16px'}}>
            <button onClick={shareResult} className="share-btn" style={{
              width: isMobile ? '100%' : 'auto',
              padding: isMobile ? '16px 28px' : '14px 28px',
              fontSize: isMobile ? '16px' : '15px'
            }}>
              üéâ Share Your Verdict
            </button>
            <p style={{fontSize:'11px',color:'var(--dim)',marginTop:'8px'}}>Let your friends settle their movie debates too!</p>
          </div>
          
          <div style={{textAlign:'center',marginBottom:'24px'}}>
            <div style={{fontSize:'48px',marginBottom:'10px',animation:'verdictReveal 0.6s ease-out'}}>‚öñÔ∏è</div>
            <h2 className="space" style={{fontSize:'28px',fontWeight:'700',marginBottom:'6px'}}>The Verdict Is In</h2>
            <p style={{color:'var(--muted)',fontSize:'13px'}}>The court has ruled. No appeals.</p>
          </div>

          <div style={{display:'flex',flexDirection:'column',gap:'16px',maxWidth:'700px',margin:'0 auto'}}>
            {result.map((r, i) => <ResultMovieCard key={r.movie.id} movie={r.movie} score={r.matchScore} rank={i + 1} isWinner={i === 0} isDiscovery={i === 0 && r.isDiscovery} />)}
          </div>

          <FairnessBar p1Percent={fairnessScore.p1} p2Percent={fairnessScore.p2} />

          <div className="picks-grid" style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(260px,1fr))',gap:'18px',marginTop:'28px',maxWidth:'700px',margin:'28px auto 0'}}>
            {[['üòá Your Picks', p1Picks, 'var(--p2)', 'üíö', 'üëé'], ['üòà Their Picks', p2Picks, 'var(--p1)', '‚ù§Ô∏è', 'üëé']].map(([name, picks, color, emoji, negEmoji]) => (
              <div key={name} style={{background:'var(--card)',borderRadius:'16px',padding:'18px',borderLeft:`4px solid ${color}`}}>
                <h4 style={{color,fontSize:'14px',fontWeight:'700',marginBottom:'12px'}}>{name}</h4>
                <div style={{display:'flex',flexDirection:'column',gap:'8px'}}>
                  {Object.values(picks).map(({movie, expr}) => (
                    <div key={movie.id} style={{display:'flex',alignItems:'center',gap:'8px',fontSize:'13px'}}>
                      <span style={{flex:1,whiteSpace:'nowrap',overflow:'hidden',textOverflow:'ellipsis',color: expr <= 2 ? 'var(--dim)' : 'inherit'}}>{movie.title}</span>
                      <span style={{color: expr <= 2 ? 'var(--dim)' : color,flexShrink:0}}>
                        {expr <= 2 ? negEmoji : emoji.repeat(Math.min(Math.max(expr - 2, 1), 4))}
                      </span>
                    </div>
                  ))}
                </div>
              </div>
            ))}
          </div>

          <div style={{maxWidth:'700px',margin:'32px auto 0'}}>
            <div style={{background:'linear-gradient(135deg, var(--card), var(--elevated))',borderRadius:'20px',padding:'24px',textAlign:'center'}}>
              <div style={{display:'flex',flexDirection:'column',gap:'12px'}}>
                {randomQuotes.map((quote, i) => (
                  <p key={i} style={{fontSize:'14px',color:'var(--muted)',fontStyle:'italic',lineHeight:'1.5',animation:`fadeIn 0.5s ease-out ${0.3 + i * 0.2}s both`}}>"{quote}"</p>
                ))}
              </div>
            </div>
          </div>

          <div style={{textAlign:'center',marginTop:'28px'}}>
            <button onClick={reset} style={{padding:'12px 32px',borderRadius:'50px',border:'2px solid var(--gold)',background:'transparent',color:'var(--gold)',fontSize:'14px',fontWeight:'600',cursor:'pointer'}}>Start Over ‚öñÔ∏è</button>
          </div>
          
          {/* Sign up prompt - show only if not logged in */}
          {!user && (
            <div style={{maxWidth:'400px',margin:'32px auto 0',padding:'0 16px'}}>
              <div style={{
                background:'linear-gradient(135deg, rgba(168,85,247,0.1), rgba(255,107,107,0.1))',
                borderRadius:'16px',padding:'20px',textAlign:'center',
                border:'1px solid rgba(168,85,247,0.2)'
              }}>
                <p style={{fontSize:'13px',color:'var(--muted)',marginBottom:'12px'}}>
                  ‚ú® Want us to remember who picked? Track your movie history?
                </p>
                <button 
                  onClick={() => setShowSignUp(true)}
                  style={{
                    padding:'10px 24px',borderRadius:'50px',border:'none',
                    background:'linear-gradient(135deg, var(--purple), var(--p1))',
                    color:'white',fontSize:'13px',fontWeight:'600',cursor:'pointer'
                  }}
                >
                  Join the Waitlist
                </button>
              </div>
            </div>
          )}
          
          {/* Copyright */}
          <p style={{
            fontSize:'10px',color:'var(--dim)',textAlign:'center',
            marginTop:'40px',paddingBottom:'20px'
          }}>
            ¬© 2026 Tyler Friddle. All Rights Reserved.
          </p>
        </div>
      )}

      {/* Global footer - hide during mobile picking phase since it has its own */}
      {!(phase === 'picking' && isMobile) && (
        <footer style={{textAlign:'center',padding:'20px 16px 0',color:'var(--dim)',fontSize:'11px'}}>
          <p style={{marginBottom:'8px'}}>¬© Tyler Friddle 2026. All rights reserved.</p>
          <p>Made for couples who need a referee üé¨</p>
        </footer>
      )}
      

    </div>
  );
};

ReactDOM.render(<App />, document.getElementById('root'));
</script>
</body>
</html>
